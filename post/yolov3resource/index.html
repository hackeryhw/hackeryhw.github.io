<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>YOLOv3&#43;Spp源码详解 - Yang’s Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="杨浩伟" /><meta name="description" content="训练脚本详解： train函数 全部工作： 参数复制 图片大小设置：设置成32的倍数；多尺度训练问题。 模型问题：初始化模型；冻结参数。 优化器、混合精" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.110.0 with theme even" />


<link rel="canonical" href="http://localhost:1313/post/yolov3resource/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="YOLOv3&#43;Spp源码详解" />
<meta property="og:description" content="训练脚本详解： train函数 全部工作： 参数复制 图片大小设置：设置成32的倍数；多尺度训练问题。 模型问题：初始化模型；冻结参数。 优化器、混合精" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/post/yolov3resource/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-02-08T09:27:55+08:00" />
<meta property="article:modified_time" content="2023-02-08T09:27:55+08:00" />
<meta itemprop="name" content="YOLOv3&#43;Spp源码详解">
<meta itemprop="description" content="训练脚本详解： train函数 全部工作： 参数复制 图片大小设置：设置成32的倍数；多尺度训练问题。 模型问题：初始化模型；冻结参数。 优化器、混合精"><meta itemprop="datePublished" content="2023-02-08T09:27:55+08:00" />
<meta itemprop="dateModified" content="2023-02-08T09:27:55+08:00" />
<meta itemprop="wordCount" content="19483">
<meta itemprop="keywords" content="YOLOv3," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="YOLOv3&#43;Spp源码详解"/>
<meta name="twitter:description" content="训练脚本详解： train函数 全部工作： 参数复制 图片大小设置：设置成32的倍数；多尺度训练问题。 模型问题：初始化模型；冻结参数。 优化器、混合精"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Yang’s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Yang’s Blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">YOLOv3&#43;Spp源码详解</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-02-08 </span>
        <div class="post-category">
            <a href="/categories/%E6%BA%90%E7%A0%81%E8%AE%B2%E8%A7%A3/"> 源码讲解 </a>
            </div>
          <span class="more-meta"> 约 19483 字 </span>
          <span class="more-meta"> 预计阅读 39 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#训练脚本详解">训练脚本详解：</a>
          <ul>
            <li><a href="#train函数">train函数</a></li>
            <li><a href="#主函数">主函数</a></li>
          </ul>
        </li>
        <li><a href="#测试脚本详解">测试脚本详解：</a></li>
        <li><a href="#配置文件详解">配置文件详解：</a>
          <ul>
            <li><a href="#解析配置文件">解析配置文件</a></li>
          </ul>
        </li>
        <li><a href="#搭建模型">搭建模型</a>
          <ul>
            <li><a href="#根据配置文件创建模型">根据配置文件创建模型</a></li>
            <li><a href="#自定义层">自定义层：</a></li>
          </ul>
        </li>
        <li><a href="#自定义数据集">自定义数据集</a>
          <ul>
            <li><a href="#mosaic数据增强">mosaic数据增强：</a></li>
            <li><a href="#图片仿射变换-数据增强">图片仿射变换 数据增强：</a></li>
            <li><a href="#正方形推测">正方形推测</a></li>
            <li><a href="#hsv数据增强">hsv数据增强</a></li>
          </ul>
        </li>
        <li><a href="#损失计算">损失计算</a></li>
        <li><a href="#总结">总结：</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="训练脚本详解">训练脚本详解：</h2>
<h3 id="train函数">train函数</h3>
<p>全部工作：</p>
<ul>
<li>参数复制</li>
<li>图片大小设置：设置成32的倍数；多尺度训练问题。</li>
<li>模型问题：初始化模型；冻结参数。</li>
<li>优化器、混合精度、学习率调度器初始化。</li>
<li>读取模型权重，恢复断点。</li>
<li>数据集loader初始化。</li>
<li>训练，验证 并 保存断点。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">hyp</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">device</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&#34;cpu&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Using </span><span class="si">{}</span><span class="s2"> device training.&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">wdir</span> <span class="o">=</span> <span class="s2">&#34;weights&#34;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>  <span class="c1"># weights dir</span>
</span></span><span class="line"><span class="cl">    <span class="n">best</span> <span class="o">=</span> <span class="n">wdir</span> <span class="o">+</span> <span class="s2">&#34;best.pt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">results_file</span> <span class="o">=</span> <span class="s2">&#34;results</span><span class="si">{}</span><span class="s2">.txt&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cfg</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">cfg</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">data</span>
</span></span><span class="line"><span class="cl">    <span class="n">epochs</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">epochs</span>
</span></span><span class="line"><span class="cl">    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">batch_size</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 固定batch size=64，可能设备显存没有那么大，通过累计更新来扩大batch size。</span>
</span></span><span class="line"><span class="cl">    <span class="n">accumulate</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mi">64</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">weights</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">weights</span>  <span class="c1"># initial training weights</span>
</span></span><span class="line"><span class="cl">    <span class="n">imgsz_train</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">img_size</span>
</span></span><span class="line"><span class="cl">    <span class="n">imgsz_test</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">img_size</span>  <span class="c1"># test image sizes</span>
</span></span><span class="line"><span class="cl">    <span class="n">multi_scale</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">multi_scale</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Image sizes</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 图像要设置成32的倍数</span>
</span></span><span class="line"><span class="cl">    <span class="n">gs</span> <span class="o">=</span> <span class="mi">32</span>  <span class="c1"># (pixels) grid size</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 判断图像大小是否为32的倍数。</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">fmod</span><span class="p">(</span><span class="n">imgsz_test</span><span class="p">,</span> <span class="n">gs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;--img-size </span><span class="si">%g</span><span class="s2"> must be a </span><span class="si">%g</span><span class="s2">-multiple&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imgsz_test</span><span class="p">,</span> <span class="n">gs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 计算网格最大最小尺寸</span>
</span></span><span class="line"><span class="cl">    <span class="n">grid_min</span><span class="p">,</span> <span class="n">grid_max</span> <span class="o">=</span> <span class="n">imgsz_test</span> <span class="o">//</span> <span class="n">gs</span><span class="p">,</span> <span class="n">imgsz_test</span> <span class="o">//</span> <span class="n">gs</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">multi_scale</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 多尺度训练时最大最小的图片尺寸</span>
</span></span><span class="line"><span class="cl">        <span class="n">imgsz_min</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">img_size</span> <span class="o">//</span> <span class="mf">1.5</span>
</span></span><span class="line"><span class="cl">        <span class="n">imgsz_max</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">img_size</span> <span class="o">//</span> <span class="mf">0.667</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 将给定的最大，最小输入尺寸向下调整到32的整数倍</span>
</span></span><span class="line"><span class="cl">        <span class="n">grid_min</span><span class="p">,</span> <span class="n">grid_max</span> <span class="o">=</span> <span class="n">imgsz_min</span> <span class="o">//</span> <span class="n">gs</span><span class="p">,</span> <span class="n">imgsz_max</span> <span class="o">//</span> <span class="n">gs</span>
</span></span><span class="line"><span class="cl">        <span class="n">imgsz_min</span><span class="p">,</span> <span class="n">imgsz_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">grid_min</span> <span class="o">*</span> <span class="n">gs</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">grid_max</span> <span class="o">*</span> <span class="n">gs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">imgsz_train</span> <span class="o">=</span> <span class="n">imgsz_max</span>  <span class="c1"># initialize with max size</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Using multi_scale training, image range[</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">]&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imgsz_min</span><span class="p">,</span> <span class="n">imgsz_max</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># configure run</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># init_seeds()  # 初始化随机种子，保证结果可复现</span>
</span></span><span class="line"><span class="cl">    <span class="n">data_dict</span> <span class="o">=</span> <span class="n">parse_data_cfg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">train_path</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&#34;train&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">test_path</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&#34;valid&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">nc</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">single_cls</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&#34;classes&#34;</span><span class="p">])</span>  <span class="c1"># number of classes</span>
</span></span><span class="line"><span class="cl">    <span class="n">hyp</span><span class="p">[</span><span class="s2">&#34;cls&#34;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">nc</span> <span class="o">/</span> <span class="mi">80</span>  <span class="c1"># update coco-tuned hyp[&#39;cls&#39;] to current dataset</span>
</span></span><span class="line"><span class="cl">    <span class="n">hyp</span><span class="p">[</span><span class="s2">&#34;obj&#34;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">imgsz_test</span> <span class="o">/</span> <span class="mi">320</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 删除原来的结果文件</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">results_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 初始化模型</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span> <span class="o">=</span> <span class="n">Darknet</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 是否冻结权重，只训练predictor的权重</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">freeze_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 索引减一对应的是predictor的索引，YOLOLayer并不是predictor</span>
</span></span><span class="line"><span class="cl">        <span class="n">output_layer_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">module_list</span><span class="p">)</span> <span class="k">if</span>
</span></span><span class="line"><span class="cl">                                <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">YOLOLayer</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 冻结除predictor和YOLOLayer外的所有层</span>
</span></span><span class="line"><span class="cl">        <span class="n">freeze_layer_indeces</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">module_list</span><span class="p">))</span> <span class="k">if</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output_layer_indices</span><span class="p">)</span> <span class="ow">and</span>
</span></span><span class="line"><span class="cl">                                <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output_layer_indices</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Freeze non-output layers</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 总共训练3x2=6个parameters</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">freeze_layer_indeces</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">module_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">parameter</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 如果freeze_layer为False，默认仅训练除darknet53之后的部分</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 若要训练全部权重，删除以下代码</span>
</span></span><span class="line"><span class="cl">        <span class="n">darknet_end_layer</span> <span class="o">=</span> <span class="mi">74</span>  <span class="c1"># only yolov3spp cfg</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Freeze darknet53 layers</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 总共训练21x3+3x2=69个parameters</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">darknet_end_layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># [0, 74]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">module_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">parameter</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># optimizer</span>
</span></span><span class="line"><span class="cl">    <span class="n">pg</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&#34;lr0&#34;</span><span class="p">],</span> <span class="n">momentum</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&#34;momentum&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                          <span class="n">weight_decay</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&#34;weight_decay&#34;</span><span class="p">],</span> <span class="n">nesterov</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">scaler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">()</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">amp</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">start_epoch</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">best_map</span> <span class="o">=</span> <span class="mf">0.0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 读取权重</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">weights</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.pt&#34;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">weights</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.pth&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      	<span class="c1"># torch.load load了权重文件中的所有东西，不止参数，还有断点信息，优化器信息等。</span>
</span></span><span class="line"><span class="cl">        <span class="n">ckpt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># load model</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">ckpt</span><span class="p">[</span><span class="s2">&#34;model&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ckpt</span><span class="p">[</span><span class="s2">&#34;model&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">numel</span><span class="p">()}</span>
</span></span><span class="line"><span class="cl">            <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">ckpt</span><span class="p">[</span><span class="s2">&#34;model&#34;</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> is not compatible with </span><span class="si">%s</span><span class="s2">. Specify --weights &#39;&#39; or specify a --cfg compatible with </span><span class="si">%s</span><span class="s2">. &#34;</span> \
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;See https://github.com/ultralytics/yolov3/issues/657&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</span></span><span class="line"><span class="cl">				<span class="c1"># 读取断点信息，继续开始训练</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># load optimizer</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ckpt</span><span class="p">[</span><span class="s2">&#34;optimizer&#34;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">ckpt</span><span class="p">[</span><span class="s2">&#34;optimizer&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;best_map&#34;</span> <span class="ow">in</span> <span class="n">ckpt</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">best_map</span> <span class="o">=</span> <span class="n">ckpt</span><span class="p">[</span><span class="s2">&#34;best_map&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># load results</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ckpt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;training_results&#34;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_file</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ckpt</span><span class="p">[</span><span class="s2">&#34;training_results&#34;</span><span class="p">])</span>  <span class="c1"># write results.txt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># epochs</span>
</span></span><span class="line"><span class="cl">        <span class="n">start_epoch</span> <span class="o">=</span> <span class="n">ckpt</span><span class="p">[</span><span class="s2">&#34;epoch&#34;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">epochs</span> <span class="o">&lt;</span> <span class="n">start_epoch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> has been trained for </span><span class="si">%g</span><span class="s1"> epochs. Fine-tuning for </span><span class="si">%g</span><span class="s1"> additional epochs.&#39;</span> <span class="o">%</span>
</span></span><span class="line"><span class="cl">                  <span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">ckpt</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">],</span> <span class="n">epochs</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">epochs</span> <span class="o">+=</span> <span class="n">ckpt</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span>  <span class="c1"># finetune additional epochs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">amp</span> <span class="ow">and</span> <span class="s2">&#34;scaler&#34;</span> <span class="ow">in</span> <span class="n">ckpt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">scaler</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">ckpt</span><span class="p">[</span><span class="s2">&#34;scaler&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">del</span> <span class="n">ckpt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Scheduler https://arxiv.org/pdf/1812.01187.pdf</span>
</span></span><span class="line"><span class="cl">    <span class="n">lf</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">epochs</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">hyp</span><span class="p">[</span><span class="s2">&#34;lrf&#34;</span><span class="p">])</span> <span class="o">+</span> <span class="n">hyp</span><span class="p">[</span><span class="s2">&#34;lrf&#34;</span><span class="p">]</span>  <span class="c1"># cosine学习率调整</span>
</span></span><span class="line"><span class="cl">    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">LambdaLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">lr_lambda</span><span class="o">=</span><span class="n">lf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">scheduler</span><span class="o">.</span><span class="n">last_epoch</span> <span class="o">=</span> <span class="n">start_epoch</span>  <span class="c1"># 指定从哪个epoch开始</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Plot lr schedule</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># y = []</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># for _ in range(epochs):</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     scheduler.step()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     y.append(optimizer.param_groups[0][&#39;lr&#39;])</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># plt.plot(y, &#39;.-&#39;, label=&#39;LambdaLR&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># plt.xlabel(&#39;epoch&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># plt.ylabel(&#39;LR&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># plt.tight_layout()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># plt.savefig(&#39;LR.png&#39;, dpi=300)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># model.yolo_layers = model.module.yolo_layers</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 读取数据和标签</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 训练集的图像尺寸指定为multi_scale_range中最大的尺寸</span>
</span></span><span class="line"><span class="cl">    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">LoadImagesAndLabels</span><span class="p">(</span><span class="n">train_path</span><span class="p">,</span> <span class="n">imgsz_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">augment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">hyp</span><span class="o">=</span><span class="n">hyp</span><span class="p">,</span>  <span class="c1"># augmentation hyperparameters</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">rect</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">rect</span><span class="p">,</span>  <span class="c1"># rectangular training</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">cache_images</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">cache_images</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">single_cls</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">single_cls</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 验证集的图像尺寸指定为img_size(512)</span>
</span></span><span class="line"><span class="cl">    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">LoadImagesAndLabels</span><span class="p">(</span><span class="n">test_path</span><span class="p">,</span> <span class="n">imgsz_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">hyp</span><span class="o">=</span><span class="n">hyp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">rect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 将每个batch的图像调整到合适大小，可减少运算量(并不是512x512标准尺寸)</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">cache_images</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">cache_images</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">single_cls</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">single_cls</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># dataloader</span>
</span></span><span class="line"><span class="cl">    <span class="n">nw</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span> <span class="n">batch_size</span> <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>  <span class="c1"># number of workers</span>
</span></span><span class="line"><span class="cl">    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">num_workers</span><span class="o">=</span><span class="n">nw</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="c1"># Shuffle=True unless rectangular training is used</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">shuffle</span><span class="o">=</span><span class="ow">not</span> <span class="n">opt</span><span class="o">.</span><span class="n">rect</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">collate_fn</span><span class="o">=</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">collate_fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># pin_memory 锁页：不与主机的虚拟内存进行交换的内存</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 内存有两种方式存在：锁页内存与不锁页内存。</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 当计算机的内存充足的时候，可以设置pin_memory=True。当系统卡住，或者交换内存使用过多的时候，设置pin_memory=False。</span>
</span></span><span class="line"><span class="cl">    <span class="n">val_datasetloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                    <span class="n">num_workers</span><span class="o">=</span><span class="n">nw</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                    <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                    <span class="n">collate_fn</span><span class="o">=</span><span class="n">val_dataset</span><span class="o">.</span><span class="n">collate_fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Model parameters 模型绑定信息</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">.</span><span class="n">nc</span> <span class="o">=</span> <span class="n">nc</span>  <span class="c1"># attach number of classes to model</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">.</span><span class="n">hyp</span> <span class="o">=</span> <span class="n">hyp</span>  <span class="c1"># attach hyperparameters to model</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">.</span><span class="n">gr</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># giou loss ratio (obj_loss = 1.0 or giou)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 计算每个类别的目标个数，并计算每个类别的比重</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># model.class_weights = labels_to_class_weights(train_dataset.labels, nc).to(device)  # attach class weights</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># start training</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># caching val_data when you have plenty of memory(RAM)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># coco = None</span>
</span></span><span class="line"><span class="cl">    <span class="n">coco</span> <span class="o">=</span> <span class="n">get_coco_api_from_dataset</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;starting traning for </span><span class="si">%g</span><span class="s2"> epochs...&#34;</span> <span class="o">%</span> <span class="n">epochs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using </span><span class="si">%g</span><span class="s1"> dataloader workers&#39;</span> <span class="o">%</span> <span class="n">nw</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_epoch</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">mloss</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">train_util</span><span class="o">.</span><span class="n">train_one_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">train_dataloader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">device</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">accumulate</span><span class="o">=</span><span class="n">accumulate</span><span class="p">,</span>  <span class="c1"># 迭代多少batch才训练完64张图片</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">img_size</span><span class="o">=</span><span class="n">imgsz_train</span><span class="p">,</span>  <span class="c1"># 输入图像的大小</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">multi_scale</span><span class="o">=</span><span class="n">multi_scale</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">grid_min</span><span class="o">=</span><span class="n">grid_min</span><span class="p">,</span>  <span class="c1"># grid的最小尺寸</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">grid_max</span><span class="o">=</span><span class="n">grid_max</span><span class="p">,</span>  <span class="c1"># grid的最大尺寸</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">gs</span><span class="o">=</span><span class="n">gs</span><span class="p">,</span>  <span class="c1"># grid step: 32</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">print_freq</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>  <span class="c1"># 每训练多少个step打印一次信息</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">warmup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">scaler</span><span class="o">=</span><span class="n">scaler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># update scheduler</span>
</span></span><span class="line"><span class="cl">        <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">notest</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">==</span> <span class="n">epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># evaluate on the test dataset</span>
</span></span><span class="line"><span class="cl">            <span class="n">result_info</span> <span class="o">=</span> <span class="n">train_util</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_datasetloader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                              <span class="n">coco</span><span class="o">=</span><span class="n">coco</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">coco_mAP</span> <span class="o">=</span> <span class="n">result_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">voc_mAP</span> <span class="o">=</span> <span class="n">result_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">coco_mAR</span> <span class="o">=</span> <span class="n">result_info</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># write into tensorboard</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">tb_writer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train/giou_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;train/obj_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;train/cls_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;train/loss&#39;</span><span class="p">,</span> <span class="s2">&#34;learning_rate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;mAP@[IoU=0.50:0.95]&#34;</span><span class="p">,</span> <span class="s2">&#34;mAP@[IoU=0.5]&#34;</span><span class="p">,</span> <span class="s2">&#34;mAR@[IoU=0.50:0.95]&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mloss</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="n">lr</span><span class="p">,</span> <span class="n">coco_mAP</span><span class="p">,</span> <span class="n">voc_mAP</span><span class="p">,</span> <span class="n">coco_mAR</span><span class="p">],</span> <span class="n">tags</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">tb_writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># write into txt</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_file</span><span class="p">,</span> <span class="s2">&#34;a&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 记录coco的12个指标加上训练总损失和lr</span>
</span></span><span class="line"><span class="cl">                <span class="n">result_info</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result_info</span> <span class="o">+</span> <span class="p">[</span><span class="n">mloss</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="mi">6</span><span class="p">))]</span>
</span></span><span class="line"><span class="cl">                <span class="n">txt</span> <span class="o">=</span> <span class="s2">&#34;epoch:</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result_info</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">txt</span> <span class="o">+</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># update best mAP(IoU=0.50:0.95)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">coco_mAP</span> <span class="o">&gt;</span> <span class="n">best_map</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">best_map</span> <span class="o">=</span> <span class="n">coco_mAP</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">savebest</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># save weights every epoch</span>
</span></span><span class="line"><span class="cl">                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                  	<span class="c1"># 保存模型参数时保存成字典</span>
</span></span><span class="line"><span class="cl">                    <span class="n">save_files</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;optimizer&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;training_results&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;best_map&#39;</span><span class="p">:</span> <span class="n">best_map</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">amp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">save_files</span><span class="p">[</span><span class="s2">&#34;scaler&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_files</span><span class="p">,</span> <span class="s2">&#34;./weights/yolov3spp-</span><span class="si">{}</span><span class="s2">.pt&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># only save best weights</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">best_map</span> <span class="o">==</span> <span class="n">coco_mAP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">save_files</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                            <span class="s1">&#39;optimizer&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                            <span class="s1">&#39;training_results&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                            <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="s1">&#39;best_map&#39;</span><span class="p">:</span> <span class="n">best_map</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">amp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">save_files</span><span class="p">[</span><span class="s2">&#34;scaler&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_files</span><span class="p">,</span> <span class="n">best</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">train_one_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">print_freq</span><span class="p">,</span> <span class="n">accumulate</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">grid_min</span><span class="p">,</span> <span class="n">grid_max</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">multi_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warmup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">metric_logger</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">MetricLogger</span><span class="p">(</span><span class="n">delimiter</span><span class="o">=</span><span class="s2">&#34;  &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">metric_logger</span><span class="o">.</span><span class="n">add_meter</span><span class="p">(</span><span class="s1">&#39;lr&#39;</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">SmoothedValue</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{value:.6f}</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;Epoch: [</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">lr_scheduler</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">warmup</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># 当训练第一轮（epoch=0）时，启用warmup训练方式，可理解为热身训练</span>
</span></span><span class="line"><span class="cl">        <span class="n">warmup_factor</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">1000</span>
</span></span><span class="line"><span class="cl">        <span class="n">warmup_iters</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">warmup_lr_scheduler</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">warmup_iters</span><span class="p">,</span> <span class="n">warmup_factor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">accumulate</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mloss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># mean losses</span>
</span></span><span class="line"><span class="cl">    <span class="n">now_lr</span> <span class="o">=</span> <span class="mf">0.</span>
</span></span><span class="line"><span class="cl">    <span class="n">nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span>  <span class="c1"># number of batches</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># imgs: [batch_size, 3, img_size, img_size]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># targets: [num_obj, 6] , that number 6 means -&gt; (img_index, obj_index, x, y, w, h)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># paths: list of img path</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metric_logger</span><span class="o">.</span><span class="n">log_every</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">print_freq</span><span class="p">,</span> <span class="n">header</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ni 统计从epoch0开始的所有batch数</span>
</span></span><span class="line"><span class="cl">        <span class="n">ni</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">nb</span> <span class="o">*</span> <span class="n">epoch</span>  <span class="c1"># number integrated batches (since train start)</span>
</span></span><span class="line"><span class="cl">        <span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">/</span> <span class="mf">255.0</span>  <span class="c1"># uint8 to float32, 0 - 255 to 0.0 - 1.0</span>
</span></span><span class="line"><span class="cl">        <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Multi-Scale</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">multi_scale</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 每训练64张图片，就随机修改一次输入图片大小，</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 由于label已转为相对坐标，故缩放图片不影响label的值</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">ni</span> <span class="o">%</span> <span class="n">accumulate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># adjust img_size (67% - 150%) every 1 batch</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 在给定最大最小输入尺寸范围内随机选取一个size(size为32的整数倍)</span>
</span></span><span class="line"><span class="cl">                <span class="n">img_size</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="n">grid_min</span><span class="p">,</span> <span class="n">grid_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">gs</span>
</span></span><span class="line"><span class="cl">            <span class="n">sf</span> <span class="o">=</span> <span class="n">img_size</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>  <span class="c1"># scale factor</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 如果图片最大边长不等于img_size, 则缩放图片，并将长和宽调整到32的整数倍</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">sf</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># gs: (pixels) grid size</span>
</span></span><span class="line"><span class="cl">                <span class="n">ns</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">sf</span> <span class="o">/</span> <span class="n">gs</span><span class="p">)</span> <span class="o">*</span> <span class="n">gs</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>  <span class="c1"># new shape (stretched to 32-multiple)</span>
</span></span><span class="line"><span class="cl">                <span class="n">imgs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ns</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 混合精度训练上下文管理器，如果在CPU环境中不起任何作用</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="n">scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># loss</span>
</span></span><span class="line"><span class="cl">            <span class="n">loss_dict</span> <span class="o">=</span> <span class="n">compute_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">losses</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">loss</span> <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">loss_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># reduce losses over all GPUs for logging purpose</span>
</span></span><span class="line"><span class="cl">        <span class="n">loss_dict_reduced</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">reduce_dict</span><span class="p">(</span><span class="n">loss_dict</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">losses_reduced</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">loss</span> <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">loss_dict_reduced</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">loss_items</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">loss_dict_reduced</span><span class="p">[</span><span class="s2">&#34;box_loss&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                <span class="n">loss_dict_reduced</span><span class="p">[</span><span class="s2">&#34;obj_loss&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                <span class="n">loss_dict_reduced</span><span class="p">[</span><span class="s2">&#34;class_loss&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                <span class="n">losses_reduced</span><span class="p">))</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">mloss</span> <span class="o">=</span> <span class="p">(</span><span class="n">mloss</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">loss_items</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># update mean losses</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">losses_reduced</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: non-finite loss, ending training &#39;</span><span class="p">,</span> <span class="n">loss_dict_reduced</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;training image path: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paths</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">losses</span> <span class="o">*=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">accumulate</span>  <span class="c1"># scale loss</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># backward</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">losses</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># optimize</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 每训练64张图片更新一次权重</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ni</span> <span class="o">%</span> <span class="n">accumulate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">scaler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">scaler</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">metric_logger</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">losses_reduced</span><span class="p">,</span> <span class="o">**</span><span class="n">loss_dict_reduced</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">now_lr</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;lr&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">metric_logger</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="n">now_lr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ni</span> <span class="o">%</span> <span class="n">accumulate</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">lr_scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># 第一轮使用warmup训练方式</span>
</span></span><span class="line"><span class="cl">            <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">mloss</span><span class="p">,</span> <span class="n">now_lr</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="主函数">主函数</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  	<span class="c1"># 解析命令行参数</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 指定epoch</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--epochs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 指定批大小</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--batch-size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 指定模型配置文件</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cfg&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;cfg/my_yolov3.cfg&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&#34;*.cfg path&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 指定数据路径</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--data&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;data/my_data.data&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;*.data path&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 指定超参数配置路径</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--hyp&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;cfg/hyp.yaml&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;hyperparameters path&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 是否开启多尺度训练</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--multi-scale&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;adjust (67</span><span class="si">%%</span><span class="s1"> - 150</span><span class="si">%%</span><span class="s1">) img_size every 10 batches&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 图片大小，32的整数倍</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--img-size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;test size&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># </span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--rect&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;rectangular training&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 是否只保存最好结果</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--savebest&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;only save best checkpoint&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 选择只测试最后一个epoch还是每个epoch训练完都测试</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--notest&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;only test final epoch&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 是否缓存图片</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cache-images&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;cache images for faster training&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 初始化权重的文件</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--weights&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;weights/yolov3-spp-ultralytics-512.pt&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;initial weights path&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--name&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;renames results.txt to results_name.txt if supplied&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 指定设备</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--device&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;device id (i.e. 0 or 0,1 or cpu)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--single-cls&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;train as single-class dataset&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 如何冻结参数—1.全部冻结，只训练检测头 2.冻结Darknet，训练其余参数</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--freeze-layers&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Freeze non-output layers&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 是否使用混合精度训练(需要GPU支持混合精度)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--amp&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Use torch.cuda.amp for mixed precision training&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">opt</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 检查文件是否存在</span>
</span></span><span class="line"><span class="cl">    <span class="n">opt</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">check_file</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">cfg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">opt</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">check_file</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">opt</span><span class="o">.</span><span class="n">hyp</span> <span class="o">=</span> <span class="n">check_file</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">hyp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">hyp</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">hyp</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start Tensorboard with &#34;tensorboard --logdir=runs&#34;, view at http://localhost:6006/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tb_writer</span> <span class="o">=</span> <span class="n">SummaryWriter</span><span class="p">(</span><span class="n">comment</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">train</span><span class="p">(</span><span class="n">hyp</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="测试脚本详解">测试脚本详解：</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">img_size</span> <span class="o">=</span> <span class="mi">512</span>  <span class="c1"># 必须是32的整数倍 [416, 512, 608]</span>
</span></span><span class="line"><span class="cl">    <span class="n">cfg</span> <span class="o">=</span> <span class="s2">&#34;cfg/my_yolov3.cfg&#34;</span>  <span class="c1"># 改成生成的.cfg文件</span>
</span></span><span class="line"><span class="cl">    <span class="n">weights_path</span> <span class="o">=</span> <span class="s2">&#34;weights/yolov3spp-voc-512.pt&#34;</span>  <span class="c1"># 改成自己训练好的权重文件</span>
</span></span><span class="line"><span class="cl">    <span class="n">json_path</span> <span class="o">=</span> <span class="s2">&#34;./data/pascal_voc_classes.json&#34;</span>  <span class="c1"># json标签文件</span>
</span></span><span class="line"><span class="cl">    <span class="n">img_path</span> <span class="o">=</span> <span class="s2">&#34;test.jpg&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfg</span><span class="p">),</span> <span class="s2">&#34;cfg file </span><span class="si">{}</span><span class="s2"> dose not exist.&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="s2">&#34;weights file </span><span class="si">{}</span><span class="s2"> dose not exist.&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">json_path</span><span class="p">),</span> <span class="s2">&#34;json file </span><span class="si">{}</span><span class="s2"> dose not exist.&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">json_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">img_path</span><span class="p">),</span> <span class="s2">&#34;image file </span><span class="si">{}</span><span class="s2"> dose not exist.&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># 加载所有的类别信息</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">class_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># 并生成索引</span>
</span></span><span class="line"><span class="cl">    <span class="n">category_index</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">):</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">class_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">input_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">img_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># 指定设备</span>
</span></span><span class="line"><span class="cl">    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&#34;cuda:0&#34;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&#34;cpu&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># 初始化模型</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span> <span class="o">=</span> <span class="n">Darknet</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">img_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 加载权重</span>
</span></span><span class="line"><span class="cl">    <span class="n">weights_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">weights_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">weights_dict</span> <span class="o">=</span> <span class="n">weights_dict</span><span class="p">[</span><span class="s2">&#34;model&#34;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&#34;model&#34;</span> <span class="ow">in</span> <span class="n">weights_dict</span> <span class="k">else</span> <span class="n">weights_dict</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">weights_dict</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 初始化一个全零的图片，通过输入图片进入模型来把模型加载到内存中。</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="n">img_size</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="c1"># 加载真实图像</span>
</span></span><span class="line"><span class="cl">        <span class="n">img_o</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>  <span class="c1"># BGR</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">img_o</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&#34;Image Not Found &#34;</span> <span class="o">+</span> <span class="n">img_path</span>
</span></span><span class="line"><span class="cl">				<span class="c1"># 输入图片放大，长边放大，短边补0</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">img_utils</span><span class="o">.</span><span class="n">letterbox</span><span class="p">(</span><span class="n">img_o</span><span class="p">,</span> <span class="n">new_shape</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Convert</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># BGR to RGB, to 3x416x416</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">/=</span> <span class="mf">255.0</span>  <span class="c1"># scale (0, 255) to (0, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># add batch dimension</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">t1</span> <span class="o">=</span> <span class="n">torch_utils</span><span class="o">.</span><span class="n">time_synchronized</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># only get inference result</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span> <span class="o">=</span> <span class="n">torch_utils</span><span class="o">.</span><span class="n">time_synchronized</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">pred</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">non_max_suppression</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">conf_thres</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">iou_thres</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">multi_label</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">t3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">t3</span> <span class="o">-</span> <span class="n">t2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pred</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;No target detected.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># process detections</span>
</span></span><span class="line"><span class="cl">        <span class="n">pred</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">scale_coords</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">pred</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">img_o</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">bboxes</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">scores</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">classes</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">pil_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img_o</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">plot_img</span> <span class="o">=</span> <span class="n">draw_objs</span><span class="p">(</span><span class="n">pil_img</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">bboxes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">classes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">scores</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">category_index</span><span class="o">=</span><span class="n">category_index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">box_thresh</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">line_thickness</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">font</span><span class="o">=</span><span class="s1">&#39;arial.ttf&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">font_size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">plot_img</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 保存预测的图片结果</span>
</span></span><span class="line"><span class="cl">        <span class="n">plot_img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&#34;test_result.jpg&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="配置文件详解">配置文件详解：</h2>
<ul>
<li><code>convolutional</code></li>
<li><code>shortcut</code>：通过<code>form</code>参数索引哪层输出与本层特征融合。</li>
<li><code>route</code>：实现<code>concat</code>操作和<code>多分支</code>操作。
<ul>
<li>当<code>layer</code>参数只有一个值时，拿到这个值的输出。</li>
<li>当<code>layer</code>参数有多个值时，<code>concat</code>这些值</li>
</ul>
</li>
<li><code>maxpool</code></li>
<li><code>yolo</code>：解析检测头的参数</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span><span class="lnt">713
</span><span class="lnt">714
</span><span class="lnt">715
</span><span class="lnt">716
</span><span class="lnt">717
</span><span class="lnt">718
</span><span class="lnt">719
</span><span class="lnt">720
</span><span class="lnt">721
</span><span class="lnt">722
</span><span class="lnt">723
</span><span class="lnt">724
</span><span class="lnt">725
</span><span class="lnt">726
</span><span class="lnt">727
</span><span class="lnt">728
</span><span class="lnt">729
</span><span class="lnt">730
</span><span class="lnt">731
</span><span class="lnt">732
</span><span class="lnt">733
</span><span class="lnt">734
</span><span class="lnt">735
</span><span class="lnt">736
</span><span class="lnt">737
</span><span class="lnt">738
</span><span class="lnt">739
</span><span class="lnt">740
</span><span class="lnt">741
</span><span class="lnt">742
</span><span class="lnt">743
</span><span class="lnt">744
</span><span class="lnt">745
</span><span class="lnt">746
</span><span class="lnt">747
</span><span class="lnt">748
</span><span class="lnt">749
</span><span class="lnt">750
</span><span class="lnt">751
</span><span class="lnt">752
</span><span class="lnt">753
</span><span class="lnt">754
</span><span class="lnt">755
</span><span class="lnt">756
</span><span class="lnt">757
</span><span class="lnt">758
</span><span class="lnt">759
</span><span class="lnt">760
</span><span class="lnt">761
</span><span class="lnt">762
</span><span class="lnt">763
</span><span class="lnt">764
</span><span class="lnt">765
</span><span class="lnt">766
</span><span class="lnt">767
</span><span class="lnt">768
</span><span class="lnt">769
</span><span class="lnt">770
</span><span class="lnt">771
</span><span class="lnt">772
</span><span class="lnt">773
</span><span class="lnt">774
</span><span class="lnt">775
</span><span class="lnt">776
</span><span class="lnt">777
</span><span class="lnt">778
</span><span class="lnt">779
</span><span class="lnt">780
</span><span class="lnt">781
</span><span class="lnt">782
</span><span class="lnt">783
</span><span class="lnt">784
</span><span class="lnt">785
</span><span class="lnt">786
</span><span class="lnt">787
</span><span class="lnt">788
</span><span class="lnt">789
</span><span class="lnt">790
</span><span class="lnt">791
</span><span class="lnt">792
</span><span class="lnt">793
</span><span class="lnt">794
</span><span class="lnt">795
</span><span class="lnt">796
</span><span class="lnt">797
</span><span class="lnt">798
</span><span class="lnt">799
</span><span class="lnt">800
</span><span class="lnt">801
</span><span class="lnt">802
</span><span class="lnt">803
</span><span class="lnt">804
</span><span class="lnt">805
</span><span class="lnt">806
</span><span class="lnt">807
</span><span class="lnt">808
</span><span class="lnt">809
</span><span class="lnt">810
</span><span class="lnt">811
</span><span class="lnt">812
</span><span class="lnt">813
</span><span class="lnt">814
</span><span class="lnt">815
</span><span class="lnt">816
</span><span class="lnt">817
</span><span class="lnt">818
</span><span class="lnt">819
</span><span class="lnt">820
</span><span class="lnt">821
</span><span class="lnt">822
</span><span class="lnt">823
</span><span class="lnt">824
</span><span class="lnt">825
</span><span class="lnt">826
</span><span class="lnt">827
</span><span class="lnt">828
</span><span class="lnt">829
</span><span class="lnt">830
</span><span class="lnt">831
</span><span class="lnt">832
</span><span class="lnt">833
</span><span class="lnt">834
</span><span class="lnt">835
</span><span class="lnt">836
</span><span class="lnt">837
</span><span class="lnt">838
</span><span class="lnt">839
</span><span class="lnt">840
</span><span class="lnt">841
</span><span class="lnt">842
</span><span class="lnt">843
</span><span class="lnt">844
</span><span class="lnt">845
</span><span class="lnt">846
</span><span class="lnt">847
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="p">[</span><span class="n">net</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Testing</span>
</span></span><span class="line"><span class="cl"><span class="c1"># batch=1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># subdivisions=1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Training</span>
</span></span><span class="line"><span class="cl"><span class="n">batch</span><span class="o">=</span><span class="mi">64</span>         
</span></span><span class="line"><span class="cl"><span class="n">subdivisions</span><span class="o">=</span><span class="mi">16</span>  
</span></span><span class="line"><span class="cl"><span class="n">width</span><span class="o">=</span><span class="mi">608</span>        
</span></span><span class="line"><span class="cl"><span class="n">height</span><span class="o">=</span><span class="mi">608</span>       
</span></span><span class="line"><span class="cl"><span class="n">channels</span><span class="o">=</span><span class="mi">3</span>       
</span></span><span class="line"><span class="cl"><span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span>     
</span></span><span class="line"><span class="cl"><span class="n">decay</span><span class="o">=</span><span class="mf">0.0005</span>     
</span></span><span class="line"><span class="cl"><span class="n">angle</span><span class="o">=</span><span class="mi">0</span>          
</span></span><span class="line"><span class="cl"><span class="n">saturation</span> <span class="o">=</span> <span class="mf">1.5</span>  
</span></span><span class="line"><span class="cl"><span class="n">exposure</span> <span class="o">=</span> <span class="mf">1.5</span> 
</span></span><span class="line"><span class="cl"><span class="n">hue</span><span class="o">=</span><span class="mf">.1</span>    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span>  
</span></span><span class="line"><span class="cl"><span class="n">burn_in</span><span class="o">=</span><span class="mi">1000</span>   
</span></span><span class="line"><span class="cl"><span class="n">max_batches</span> <span class="o">=</span> <span class="mi">500200</span> 
</span></span><span class="line"><span class="cl"><span class="n">policy</span><span class="o">=</span><span class="n">steps</span>  
</span></span><span class="line"><span class="cl"><span class="n">steps</span><span class="o">=</span><span class="mi">400000</span><span class="p">,</span><span class="mi">450000</span> 
</span></span><span class="line"><span class="cl"><span class="n">scales</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.1</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#卷积层</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># BN层，1表示使用，0表示不使用</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果使用，则卷积层的bias要设置成False</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># 卷积核数</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">32</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 卷积核大小</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>      
</span></span><span class="line"><span class="cl"><span class="c1">#卷积步长</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>   
</span></span><span class="line"><span class="cl"><span class="c1"># 是否使用padding，使用时固定padding大小为kernal_size/2</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>   
</span></span><span class="line"><span class="cl"><span class="c1"># 激活函数</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Downsample</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>    
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">64</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">2</span>          
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">32</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">64</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 短连接</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="c1"># 与前面哪一层的*输出*进行融合</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 则跨越两个卷积层</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>      
</span></span><span class="line"><span class="cl"><span class="c1"># 线性激活函数</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Downsample</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">64</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">64</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Downsample</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Downsample</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Downsample</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">1024</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">1024</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">1024</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">1024</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">1024</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">shortcut</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span><span class="o">=-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">######################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">1024</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### SPP ###</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">maxpool</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># maxpool层 </span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="c1">#池化层步距和核大小</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">route</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 当只有一个层时，表示返回这个层的输出。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 当有多个值时，表示返回这些层输出在深度方向上的拼接。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这里表示路由到上上层，然后后续再进行maxpool，用于多尺度检测所使用的。</span>
</span></span><span class="line"><span class="cl"><span class="n">layers</span><span class="o">=-</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">maxpool</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">9</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">route</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">layers</span><span class="o">=-</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">maxpool</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">13</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">route</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">layers</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="o">-</span><span class="mi">6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### End SPP ###</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">1024</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">1024</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># bn = 0</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">255</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">yolo</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这一层检测器用到哪些anchor</span>
</span></span><span class="line"><span class="cl"><span class="n">mask</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span>  
</span></span><span class="line"><span class="cl"><span class="c1"># yolov3所使用的anchor的宽高（W，H），前三个用于小目标，中间三个用于中目标，最后三个用于大目标。</span>
</span></span><span class="line"><span class="cl"><span class="n">anchors</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span>  <span class="mi">33</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span>  <span class="mi">62</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span>  <span class="mi">59</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span>  <span class="mi">116</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span>  <span class="mi">156</span><span class="p">,</span><span class="mi">198</span><span class="p">,</span>  <span class="mi">373</span><span class="p">,</span><span class="mi">326</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 目标类别数</span>
</span></span><span class="line"><span class="cl"><span class="n">classes</span><span class="o">=</span><span class="mi">80</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># 以下参数未使用</span>
</span></span><span class="line"><span class="cl"><span class="n">num</span><span class="o">=</span><span class="mi">9</span>
</span></span><span class="line"><span class="cl"><span class="n">jitter</span><span class="o">=</span><span class="mf">.3</span>
</span></span><span class="line"><span class="cl"><span class="n">ignore_thresh</span> <span class="o">=</span> <span class="mf">.7</span>
</span></span><span class="line"><span class="cl"><span class="n">truth_thresh</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">random</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">route</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">layers</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">upsample</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">route</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">layers</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">61</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># concatenate后768通道数</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Conv set 1 = 256，512，256，512，256，512</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">512</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#一个像素点 channel = 255 = 83 * 3 一个像素点三个anchor</span>
</span></span><span class="line"><span class="cl"><span class="c1"># bn = 0 说明后面接yolo检测头</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">255</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">yolo</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">mask</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="n">anchors</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span>  <span class="mi">33</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span>  <span class="mi">62</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span>  <span class="mi">59</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span>  <span class="mi">116</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span>  <span class="mi">156</span><span class="p">,</span><span class="mi">198</span><span class="p">,</span>  <span class="mi">373</span><span class="p">,</span><span class="mi">326</span>
</span></span><span class="line"><span class="cl"><span class="n">classes</span><span class="o">=</span><span class="mi">80</span>
</span></span><span class="line"><span class="cl"><span class="n">num</span><span class="o">=</span><span class="mi">9</span>
</span></span><span class="line"><span class="cl"><span class="n">jitter</span><span class="o">=</span><span class="mf">.3</span>
</span></span><span class="line"><span class="cl"><span class="n">ignore_thresh</span> <span class="o">=</span> <span class="mf">.7</span>
</span></span><span class="line"><span class="cl"><span class="n">truth_thresh</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">random</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">route</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">layers</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">upsample</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">route</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">layers</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">36</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Conv set 2 : 128，256，128，256，128，256</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_normalize</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">leaky</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">convolutional</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pad</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">filters</span><span class="o">=</span><span class="mi">255</span>
</span></span><span class="line"><span class="cl"><span class="n">activation</span><span class="o">=</span><span class="n">linear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">yolo</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">anchors</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span>  <span class="mi">33</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span>  <span class="mi">62</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span>  <span class="mi">59</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span>  <span class="mi">116</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span>  <span class="mi">156</span><span class="p">,</span><span class="mi">198</span><span class="p">,</span>  <span class="mi">373</span><span class="p">,</span><span class="mi">326</span>
</span></span><span class="line"><span class="cl"><span class="n">classes</span><span class="o">=</span><span class="mi">80</span>
</span></span><span class="line"><span class="cl"><span class="n">num</span><span class="o">=</span><span class="mi">9</span>
</span></span><span class="line"><span class="cl"><span class="n">jitter</span><span class="o">=</span><span class="mf">.3</span>
</span></span><span class="line"><span class="cl"><span class="n">ignore_thresh</span> <span class="o">=</span> <span class="mf">.7</span>
</span></span><span class="line"><span class="cl"><span class="n">truth_thresh</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">random</span><span class="o">=</span><span class="mi">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="解析配置文件">解析配置文件</h3>
<ul>
<li>检查配置文件是否存在</li>
<li>读取文件
<ul>
<li>以<code>#</code>开头的行舍去。</li>
<li>初始化字典：
<ul>
<li>如果以<code>[</code>开头，这行的[1:-1]赋值给<code>type</code>字段。</li>
<li>以<code>=</code>分割键值对，分别添加到字典中。</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_model_cfg</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 检查文件是否存在</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.cfg&#34;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&#34;the cfg file not exist...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 读取文件信息</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 去除空行和注释行</span>
</span></span><span class="line"><span class="cl">    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;#&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 去除每行开头和结尾的空格符</span>
</span></span><span class="line"><span class="cl">    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mdefs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># module definitions</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;[&#34;</span><span class="p">):</span>  <span class="c1"># this marks the start of a new block</span>
</span></span><span class="line"><span class="cl">            <span class="n">mdefs</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
</span></span><span class="line"><span class="cl">            <span class="n">mdefs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&#34;type&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># 记录module类型</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 如果是卷积模块，设置默认不使用BN(普通卷积层后面会重写成1，最后的预测层conv保持为0)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 因为有的卷积模块不使用bn，所以直接不写bn=1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">mdefs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&#34;type&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;convolutional&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">mdefs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&#34;batch_normalize&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;=&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&#34;anchors&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># anchors = 10,13,  16,30,  33,23,  30,61,  62,45,  59,119,  116,90,  156,198,  373,326</span>
</span></span><span class="line"><span class="cl">                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>  <span class="c1"># 将空格去除</span>
</span></span><span class="line"><span class="cl">                <span class="n">mdefs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">)])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># np anchors</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;from&#34;</span><span class="p">,</span> <span class="s2">&#34;layers&#34;</span><span class="p">,</span> <span class="s2">&#34;mask&#34;</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&#34;size&#34;</span> <span class="ow">and</span> <span class="s2">&#34;,&#34;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">mdefs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># TODO: .isnumeric() actually fails to get the float case</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">():</span>  <span class="c1"># return int or float 如果是数值的情况</span>
</span></span><span class="line"><span class="cl">                    <span class="n">mdefs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">mdefs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>  <span class="c1"># return string  是字符的情况</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># check all fields are supported</span>
</span></span><span class="line"><span class="cl">    <span class="n">supported</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;batch_normalize&#39;</span><span class="p">,</span> <span class="s1">&#39;filters&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;stride&#39;</span><span class="p">,</span> <span class="s1">&#39;pad&#39;</span><span class="p">,</span> <span class="s1">&#39;activation&#39;</span><span class="p">,</span> <span class="s1">&#39;layers&#39;</span><span class="p">,</span> <span class="s1">&#39;groups&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="s1">&#39;anchors&#39;</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">,</span> <span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="s1">&#39;jitter&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore_thresh&#39;</span><span class="p">,</span> <span class="s1">&#39;truth_thresh&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="s1">&#39;stride_x&#39;</span><span class="p">,</span> <span class="s1">&#39;stride_y&#39;</span><span class="p">,</span> <span class="s1">&#39;weights_type&#39;</span><span class="p">,</span> <span class="s1">&#39;weights_normalization&#39;</span><span class="p">,</span> <span class="s1">&#39;scale_x_y&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_nms&#39;</span><span class="p">,</span> <span class="s1">&#39;nms_kind&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="s1">&#39;iou_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;iou_normalizer&#39;</span><span class="p">,</span> <span class="s1">&#39;cls_normalizer&#39;</span><span class="p">,</span> <span class="s1">&#39;iou_thresh&#39;</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 遍历检查每个模型的配置</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mdefs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># 0对应net配置</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 遍历每个配置字典中的key值</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;Unsupported fields:</span><span class="si">{}</span><span class="s2"> in cfg&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">mdefs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_data_cfg</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Parses the data configuration file</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">path</span><span class="p">):</span>  <span class="c1"># add data/ prefix if omitted</span>
</span></span><span class="line"><span class="cl">        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">options</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="搭建模型">搭建模型</h2>
<ul>
<li>通过解析结果一层层搭建模型，记录哪些层被后面层使用过。</li>
<li>循环前向传播，如果某一层被后面层使用到，则记录这层结果（在后面层前向传播的时候输入）。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Darknet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    YOLOv3 spp object detection model
</span></span></span><span class="line"><span class="cl"><span class="s2">    cfg : 配置文件
</span></span></span><span class="line"><span class="cl"><span class="s2">    img_size：构建ONN模型时使用
</span></span></span><span class="line"><span class="cl"><span class="s2">    verbose：构建模型时是否打印模型详细信息
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="p">(</span><span class="mi">416</span><span class="p">,</span> <span class="mi">416</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">(</span><span class="n">Darknet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 这里传入的img_size只在导出ONNX模型时起作用</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">input_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">img_size</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">img_size</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 解析网络对应的.cfg文件</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">module_defs</span> <span class="o">=</span> <span class="n">parse_model_cfg</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 根据解析的配置文件一层一层去搭建***跳转至下一小标题</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">module_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">routs</span> <span class="o">=</span> <span class="n">create_modules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_defs</span><span class="p">,</span> <span class="n">img_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取所有YOLOLayer层的索引，相对于整个模型的层索引</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">yolo_layers</span> <span class="o">=</span> <span class="n">get_yolo_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 打印下模型的信息，如果verbose为True则打印详细信息</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ONNX_EXPORT</span> <span class="k">else</span> <span class="kc">None</span>  <span class="c1"># print model description</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_once</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># yolo_out收集每个yolo_layer层的输出</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># out收集每个模块的输出</span>
</span></span><span class="line"><span class="cl">        <span class="n">yolo_out</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">str</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 因为 残差和concat中，forward函数中需要out参数，所以单领出来。</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;WeightedFeatureFusion&#34;</span><span class="p">,</span> <span class="s2">&#34;FeatureConcat&#34;</span><span class="p">]:</span>  <span class="c1"># sum, concat</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">module</span><span class="o">.</span><span class="n">layers</span>  <span class="c1"># layers</span>
</span></span><span class="line"><span class="cl">                    <span class="n">sh</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">layers</span><span class="p">]</span>  <span class="c1"># shapes</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39; &gt;&gt; &#39;</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;layer </span><span class="si">%g</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">sh</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">                <span class="n">x</span> <span class="o">=</span> <span class="n">module</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>  <span class="c1"># WeightedFeatureFusion(), FeatureConcat()</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&#34;YOLOLayer&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">yolo_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  <span class="c1"># run module directly, i.e. mtype = &#39;convolutional&#39;, &#39;upsample&#39;, &#39;maxpool&#39;, &#39;batchnorm2d&#39; etc.</span>
</span></span><span class="line"><span class="cl">                <span class="n">x</span> <span class="o">=</span> <span class="n">module</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="c1"># 记录所有被使用层的输出</span>
</span></span><span class="line"><span class="cl">            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">routs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">/</span><span class="si">%g</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> -&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_list</span><span class="p">),</span> <span class="n">name</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>  <span class="c1"># train</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">yolo_out</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">ONNX_EXPORT</span><span class="p">:</span>  <span class="c1"># export</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># x = [torch.cat(x, 0) for x in zip(*yolo_out)]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># return x[0], torch.cat(x[1:3], 1)  # scores, boxes: 3780x80, 3780x4</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">yolo_out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># # 根据objectness虑除低概率目标</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># mask = torch.nonzero(torch.gt(p[:, 4], 0.1), as_tuple=False).squeeze(1)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># # onnx不支持超过一维的索引（pytorch太灵活了）</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># # p = p[mask]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># p = torch.index_select(p, dim=0, index=mask)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># # 虑除小面积目标，w &gt; 2 and h &gt; 2 pixel</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># # ONNX暂不支持bitwise_and和all操作</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># mask_s = torch.gt(p[:, 2], 2./self.input_size[0]) &amp; torch.gt(p[:, 3], 2./self.input_size[1])</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># mask_s = torch.nonzero(mask_s, as_tuple=False).squeeze(1)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># p = torch.index_select(p, dim=0, index=mask_s)  # width-height 虑除小目标</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># if mask_s.numel() == 0:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#     return torch.empty([0, 85])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>  <span class="c1"># inference or test</span>
</span></span><span class="line"><span class="cl">          	<span class="c1"># 每个yololayer有两个输出，一个是预测值通过公式变成测试输出，另一个是纯预测输出，只调整了形状。</span>
</span></span><span class="line"><span class="cl">            <span class="n">x</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">yolo_out</span><span class="p">)</span>  <span class="c1"># inference output, training output</span>
</span></span><span class="line"><span class="cl">            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># cat yolo outputs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        打印模型的信息
</span></span></span><span class="line"><span class="cl"><span class="s2">        :param verbose:
</span></span></span><span class="line"><span class="cl"><span class="s2">        :return:
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">torch_utils</span><span class="o">.</span><span class="n">model_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="根据配置文件创建模型">根据配置文件创建模型</h3>
<ul>
<li>统计两个数据：
<ul>
<li>统计哪些特征层的输出会被后续的层使用到——实现<code>yolo</code>层以及<code>shortcut</code>层</li>
<li>记录所有层的输出通道数——计算<code>shortcut</code>层之后的通道数</li>
</ul>
</li>
<li>卷积层，池化层：都是使用参数搭建即可</li>
<li><code>shortcut</code>：记录<code>from</code>参数，并计算通道数</li>
<li><code>route</code>：记录<code>layer</code>参数</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create_modules</span><span class="p">(</span><span class="n">modules_defs</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">img_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Constructs module list of layer blocks from module configuration in module_defs
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param modules_defs: 通过.cfg文件解析得到的每个层结构的列表
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param img_size:
</span></span></span><span class="line"><span class="cl"><span class="s2">    :return:
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># 搭建网络时不用管</span>
</span></span><span class="line"><span class="cl">    <span class="n">img_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">img_size</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">img_size</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 删除解析cfg列表中的第一个配置(对应[net]的配置)</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># net配置不会使用</span>
</span></span><span class="line"><span class="cl">    <span class="n">modules_defs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># cfg training hyperparams (unused)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 记录所有层的输出通道数，以便route层索引并计算结果</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_filters</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># input channels</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 初始化一个modulelist</span>
</span></span><span class="line"><span class="cl">    <span class="n">module_list</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 统计哪些特征层的输出会被后续的层使用到(可能是特征融合，也可能是拼接)</span>
</span></span><span class="line"><span class="cl">    <span class="n">routs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of layers which rout to deeper layers</span>
</span></span><span class="line"><span class="cl">    <span class="n">yolo_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 遍历搭建每个层结构</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mdef</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">modules_defs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">modules</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;convolutional&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">bn</span> <span class="o">=</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;batch_normalize&#34;</span><span class="p">]</span>  <span class="c1"># 1 or 0 / use or not</span>
</span></span><span class="line"><span class="cl">            <span class="n">filters</span> <span class="o">=</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;filters&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">k</span> <span class="o">=</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;size&#34;</span><span class="p">]</span>  <span class="c1"># kernel size</span>
</span></span><span class="line"><span class="cl">            <span class="n">stride</span> <span class="o">=</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;stride&#34;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&#34;stride&#34;</span> <span class="ow">in</span> <span class="n">mdef</span> <span class="k">else</span> <span class="p">(</span><span class="n">mdef</span><span class="p">[</span><span class="s1">&#39;stride_y&#39;</span><span class="p">],</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;stride_x&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">modules</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&#34;Conv2d&#34;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">output_filters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                                       <span class="n">out_channels</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                       <span class="n">kernel_size</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                       <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                       <span class="n">padding</span><span class="o">=</span><span class="n">k</span> <span class="o">//</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;pad&#34;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                       <span class="n">bias</span><span class="o">=</span><span class="ow">not</span> <span class="n">bn</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&#34;conv2d filter size must be int type.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">bn</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">modules</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&#34;BatchNorm2d&#34;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">filters</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 如果该卷积操作没有bn层，意味着该层为yolo的predictor（只有yolo的检测头的卷积没有bn），这时候在后面需要使用这个特征图，所以保存索引。</span>
</span></span><span class="line"><span class="cl">                <span class="n">routs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c1"># detection output (goes into yolo layer)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;activation&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;leaky&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">modules</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s2">&#34;activation&#34;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;BatchNorm2d&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="c1">#yolov3+spp中没有单独用到bn</span>
</span></span><span class="line"><span class="cl">            <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;maxpool&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">k</span> <span class="o">=</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;size&#34;</span><span class="p">]</span>  <span class="c1"># kernel size</span>
</span></span><span class="line"><span class="cl">            <span class="n">stride</span> <span class="o">=</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;stride&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">modules</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;upsample&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="c1"># 是否要导出ONN</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">ONNX_EXPORT</span><span class="p">:</span>  <span class="c1"># explicitly state size, avoid scale_factor</span>
</span></span><span class="line"><span class="cl">                <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">yolo_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">32</span>  <span class="c1"># gain</span>
</span></span><span class="line"><span class="cl">                <span class="n">modules</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">img_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">              <span class="c1"># sacle_factor :指定输出是输入的多少倍</span>
</span></span><span class="line"><span class="cl">              <span class="c1"># 可选算法： ‘nearest’, ‘linear’, ‘bilinear’, ‘bicubic’，‘trilinear’. 默认: ‘nearest’</span>
</span></span><span class="line"><span class="cl">                <span class="n">modules</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;stride&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;route&#34;</span><span class="p">:</span>  <span class="c1"># [-2],  [-1,-3,-5,-6], [-1, 61]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 先拿到层数</span>
</span></span><span class="line"><span class="cl">            <span class="n">layers</span> <span class="o">=</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;layers&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 算出n个层concat起来输出的特征图数量</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 如果l&gt;0,说明是从前往后算，这个时候索引需+1，因为开始时output_filters里有值，l&lt;0表示从后往前索引，没有任何问题。</span>
</span></span><span class="line"><span class="cl">            <span class="n">filters</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">output_filters</span><span class="p">[</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 统计哪些特征层的输出会被后续的层使用到</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 若 l&lt;0，表示从后往前索引层，由于是某层的输出，所以需+1</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 若 l&gt;0，没问题。</span>
</span></span><span class="line"><span class="cl">            <span class="n">routs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">i</span> <span class="o">+</span> <span class="n">l</span> <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">modules</span> <span class="o">=</span> <span class="n">FeatureConcat</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;shortcut&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">layers</span> <span class="o">=</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;from&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 特征融合中前一层输出特征数。</span>
</span></span><span class="line"><span class="cl">            <span class="n">filters</span> <span class="o">=</span> <span class="n">output_filters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># routs.extend([i + l if l &lt; 0 else l for l in layers])</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 统计哪些特征层的输出会被后续的层使用到，因为layer只是倒着索引，所以就是i + layers[0]</span>
</span></span><span class="line"><span class="cl">            <span class="n">routs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 通过WeightedFeatureFusion进行特征融合。经过上面的经验，WeightedFeatureFusion实现：init函数保存参数，forward函数通过输入output来特征相加。</span>
</span></span><span class="line"><span class="cl">            <span class="n">modules</span> <span class="o">=</span> <span class="n">WeightedFeatureFusion</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&#34;weights_type&#34;</span> <span class="ow">in</span> <span class="n">mdef</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;yolo&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">yolo_index</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># 记录是第几个yolo_layer [0, 1, 2]</span>
</span></span><span class="line"><span class="cl">            <span class="n">stride</span> <span class="o">=</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>  <span class="c1"># 预测特征层对应原图的缩放比例</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">modules</span> <span class="o">=</span> <span class="n">YOLOLayer</span><span class="p">(</span><span class="n">anchors</span><span class="o">=</span><span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;anchors&#34;</span><span class="p">][</span><span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;mask&#34;</span><span class="p">]],</span>  <span class="c1"># 指定使用哪三个anchors anchor list</span>
</span></span><span class="line"><span class="cl">                                <span class="n">nc</span><span class="o">=</span><span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;classes&#34;</span><span class="p">],</span>  <span class="c1"># number of classes</span>
</span></span><span class="line"><span class="cl">                                <span class="n">img_size</span><span class="o">=</span><span class="n">img_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">[</span><span class="n">yolo_index</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Initialize preceding Conv2d() bias (https://arxiv.org/pdf/1708.02002.pdf section 3.3)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 因为检测头上是不使用BN的，所以可以使用bias，这里使用focalloss的bias初始化初始化bias。</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># bias: shape(255,) 索引0对应Sequential中的Conv2d</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># view: shape(3, 85)</span>
</span></span><span class="line"><span class="cl">                <span class="n">b</span> <span class="o">=</span> <span class="n">module_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">na</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mf">4.5</span>  <span class="c1"># obj</span>
</span></span><span class="line"><span class="cl">                <span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.6</span> <span class="o">/</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">nc</span> <span class="o">-</span> <span class="mf">0.99</span><span class="p">))</span>  <span class="c1"># cls (sigmoid(p) = 1/nc)</span>
</span></span><span class="line"><span class="cl">                <span class="n">module_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: smart bias initialization failure.&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Warning: Unrecognized Layer Type: &#34;</span> <span class="o">+</span> <span class="n">mdef</span><span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Register module list and number of output filters</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 记录module</span>
</span></span><span class="line"><span class="cl">        <span class="n">module_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 记录通道数</span>
</span></span><span class="line"><span class="cl">        <span class="n">output_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># 初始化一个序列</span>
</span></span><span class="line"><span class="cl">    <span class="n">routs_binary</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">modules_defs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 序列转换</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">routs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">routs_binary</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">module_list</span><span class="p">,</span> <span class="n">routs_binary</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="自定义层">自定义层：</h3>
<h4 id="route层">route层</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FeatureConcat</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    将多个特征矩阵在channel维度进行concatenate拼接
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">(</span><span class="n">FeatureConcat</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 先拿到concat的索引</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">layers</span>  <span class="c1"># layer indices</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 判断层个数是否大于1</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>  <span class="c1"># multiple layers flag</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      	<span class="c1"># outputs：前面所有的结果</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 直接concat	或者 直接输出一层。</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple</span> <span class="k">else</span> <span class="n">outputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="resduial层">resduial层</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">WeightedFeatureFusion</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>  <span class="c1"># weighted sum of 2 or more layers https://arxiv.org/abs/1911.09070</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    将多个特征矩阵的值进行融合(add操作)
</span></span></span><span class="line"><span class="cl"><span class="s2">    weight没使用到
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">(</span><span class="n">WeightedFeatureFusion</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">layers</span>  <span class="c1"># layer indices</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>  <span class="c1"># apply weights boolean</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># number of layers 融合的特征矩阵个数,yolov3中就2层</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">weight</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># layer weights</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># outputs：前面所有的层的输出结果</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># x：残差层的相连输入</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Weights</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>  <span class="c1"># sigmoid weights (0-1)</span>
</span></span><span class="line"><span class="cl">            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Fusion</span>
</span></span><span class="line"><span class="cl">        <span class="n">nx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># input channels</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># n只有2，</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">         		<span class="c1"># a 就是残差层的另一个输入</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">w</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="k">else</span> <span class="n">outputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>  <span class="c1"># feature to add</span>
</span></span><span class="line"><span class="cl">            <span class="n">na</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># feature channels</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Adjust channels</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 根据相加的两个特征矩阵的channel选择相加方式</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">nx</span> <span class="o">==</span> <span class="n">na</span><span class="p">:</span>  <span class="c1"># same shape 如果channel相同，直接相加</span>
</span></span><span class="line"><span class="cl">                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">nx</span> <span class="o">&gt;</span> <span class="n">na</span><span class="p">:</span>  <span class="c1"># slice input 如果channel不同，将channel多的特征矩阵砍掉部分channel保证相加的channel一致</span>
</span></span><span class="line"><span class="cl">                <span class="n">x</span><span class="p">[:,</span> <span class="p">:</span><span class="n">na</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="p">:</span><span class="n">na</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span>  <span class="c1"># or a = nn.ZeroPad2d((0, 0, 0, 0, 0, dc))(a); x = x + a</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  <span class="c1"># slice feature</span>
</span></span><span class="line"><span class="cl">                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">a</span><span class="p">[:,</span> <span class="p">:</span><span class="n">nx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">x</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="yolo层">YOLO层</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span><span class="lnt">99
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">YOLOLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    对预测头的输出结果进行处理，对YOLO的输出进行处理
</span></span></span><span class="line"><span class="cl"><span class="s2">    训练阶段：改改检测头的输出形状
</span></span></span><span class="line"><span class="cl"><span class="s2">    推理阶段：
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="n">stride</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">(</span><span class="n">YOLOLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># anchor转换格式</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># yolo的步长</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span>  <span class="c1"># layer stride 特征图上一步对应原图上的步距 [32, 16, 8]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># anchor的数量</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">na</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>  <span class="c1"># number of anchors (3)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 类别的数量</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">nc</span> <span class="o">=</span> <span class="n">nc</span>  <span class="c1"># number of classes (80)</span>
</span></span><span class="line"><span class="cl">				<span class="c1"># 输出特征图通道数</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">no</span> <span class="o">=</span> <span class="n">nc</span> <span class="o">+</span> <span class="mi">5</span>  <span class="c1"># number of outputs (85: x, y, w, h, obj, cls1, ...)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 预测特征层的宽度和高度</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 网格的大小（就是）</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ng</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># initialize number of x, y gridpoints</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 将anchors大小缩放到grid尺度</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">anchor_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 批量，每个中心点预测的anchor数，网格的高，网格（棋盘）的宽，anchor的宽和高</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># batch_size, na, grid_h, grid_w, wh</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 值为1的维度对应的值不是固定值，后续操作可根据broadcast广播机制自动扩充</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># batchsize，网格的宽和高这三个值会随着yolo层数不同而变化，所以想使用广播机制自动填充</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">anchor_wh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_vec</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">na</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ONNX_EXPORT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">create_grids</span><span class="p">((</span><span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">stride</span><span class="p">,</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">stride</span><span class="p">))</span>  <span class="c1"># number x, y grid points</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">create_grids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ng</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="s2">&#34;cpu&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        更新grids信息并生成新的grids参数
</span></span></span><span class="line"><span class="cl"><span class="s2">        :param ng: 特征图大小
</span></span></span><span class="line"><span class="cl"><span class="s2">        :param device:
</span></span></span><span class="line"><span class="cl"><span class="s2">        :return:
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="n">ng</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ng</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ng</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># build xy offsets 构建每个cell处的anchor的xy偏移量(在feature map上的)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>  <span class="c1"># 训练模式不需要回归到最终预测boxes</span>
</span></span><span class="line"><span class="cl">          <span class="c1"># meshgrid：通过两个参数构造网格，并返回网格中每个点纵坐标和横坐标</span>
</span></span><span class="line"><span class="cl">            <span class="n">yv</span><span class="p">,</span> <span class="n">xv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># meshgrid完接stack（dim=2）是固定操作，用于生成网格真实坐标</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># batch_size, na, grid_h, grid_w, wh</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">xv</span><span class="p">,</span> <span class="n">yv</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_vec</span><span class="o">.</span><span class="n">device</span> <span class="o">!=</span> <span class="n">device</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">anchor_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_vec</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">anchor_wh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_wh</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ONNX_EXPORT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">bs</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># batch size</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          	<span class="c1"># 			特征矩阵的宽高</span>
</span></span><span class="line"><span class="cl">            <span class="n">bs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># batch_size, predict_param(255=85*3), grid(13), grid(13)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">              <span class="c1"># 当self.grid为None或者(self.nx, self.ny) != (nx, ny)时，重新创建grid</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">create_grids</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="n">p</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># view: (batch_size, 255, 13, 13) -&gt; (batch_size, 3, 85, 13, 13)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># permute: (batch_size, 3, 85, 13, 13) -&gt; (batch_size, 3, 13, 13, 85)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># [bs, num_of_anchor(3), grid_y, grid_x, xywh + obj + classes]</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">na</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>  <span class="c1"># prediction</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">ONNX_EXPORT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Avoid broadcasting for ANE operations</span>
</span></span><span class="line"><span class="cl">            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">na</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span>  <span class="c1"># 3*</span>
</span></span><span class="line"><span class="cl">            <span class="n">ng</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ng</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">na</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">anchor_wh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_wh</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">ng</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># xy = torch.sigmoid(p[:, 0:2]) + grid  # x, y</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># wh = torch.exp(p[:, 2:4]) * anchor_wh  # width, height</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># p_cls = torch.sigmoid(p[:, 4:5]) if self.nc == 1 else \</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#     torch.sigmoid(p[:, 5:self.no]) * torch.sigmoid(p[:, 4:5])  # conf</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">grid</span><span class="p">)</span> <span class="o">*</span> <span class="n">ng</span>  <span class="c1"># x, y</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">anchor_wh</span>  <span class="c1"># width, height</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">no</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>  <span class="c1"># inference</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># [bs, anchor, grid, grid, xywh + obj + classes]</span>
</span></span><span class="line"><span class="cl">            <span class="n">io</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>  <span class="c1"># inference output</span>
</span></span><span class="line"><span class="cl">            <span class="n">io</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span>  <span class="c1"># xy 计算在feature map上的xy坐标——公式</span>
</span></span><span class="line"><span class="cl">            <span class="n">io</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_wh</span>  <span class="c1"># wh yolo method 计算在feature map上的wh——公式</span>
</span></span><span class="line"><span class="cl">            <span class="n">io</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span>  <span class="c1"># 换算映射回原图尺度——公式</span>
</span></span><span class="line"><span class="cl">            <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid_</span><span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">4</span><span class="p">:])</span> <span class="c1"># 类别做激活</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span><span class="p">),</span> <span class="n">p</span>  <span class="c1"># view [1, 3, 13, 13, 85] as [1, 507, 85]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="自定义数据集">自定义数据集</h2>
<ul>
<li></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LoadImagesAndLabels</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>  <span class="c1"># for training/testing</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">path</span><span class="p">,</span>   <span class="c1"># 指向data/my_train_data.txt路径或data/my_val_data.txt路径</span>
</span></span><span class="line"><span class="cl">                 
</span></span><span class="line"><span class="cl">                 <span class="c1"># 这里设置的是预处理后输出的图片尺寸</span>
</span></span><span class="line"><span class="cl">                 <span class="c1"># 当为训练集时，设置的是训练过程中(开启多尺度)的最大尺寸</span>
</span></span><span class="line"><span class="cl">                 <span class="c1"># 当为验证集时，设置的是最终使用的网络大小</span>
</span></span><span class="line"><span class="cl">                 <span class="n">img_size</span><span class="o">=</span><span class="mi">416</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="c1"># 批大小</span>
</span></span><span class="line"><span class="cl">                 <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="c1"># 是否图像增强</span>
</span></span><span class="line"><span class="cl">                 <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># 训练集设置为True(augment_hsv)，验证集设置为False</span>
</span></span><span class="line"><span class="cl">                 <span class="n">hyp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># 超参数字典，其中包含图像增强会使用到的超参数</span>
</span></span><span class="line"><span class="cl">                 <span class="n">rect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># 是否使用rectangular training</span>
</span></span><span class="line"><span class="cl">                 <span class="n">cache_images</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># 是否缓存图片到内存中</span>
</span></span><span class="line"><span class="cl">                 <span class="n">single_cls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">rank</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          	<span class="c1"># 将路径进行标准化</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># parent = str(Path(path).parent) + os.sep</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 判断是否是文件，如果是文件就读取每一行，如果不是文件就报错</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>  <span class="c1"># file</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 读取对应my_train/val_data.txt文件，读取每一行的图片路径信息</span>
</span></span><span class="line"><span class="cl">                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> does not exist&#34;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 检查每张图片后缀格式是否在支持的列表中，保存支持的图像路径</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># img_formats = [&#39;.bmp&#39;, &#39;.jpg&#39;, &#39;.jpeg&#39;, &#39;.png&#39;, &#39;.tif&#39;, &#39;.dng&#39;]</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#	os.path.splitext(x) 分割文件名与类型</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">img_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">img_formats</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># 防止不同系统排序不同，导致shape文件出现差异</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 此时图片是以图片名为顺序排放的</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&#34;Error loading data from </span><span class="si">{}</span><span class="s2">. </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 如果图片列表中没有图片，则报错</span>
</span></span><span class="line"><span class="cl">        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;No images found in </span><span class="si">%s</span><span class="s2">. See </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">help_url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># batch index</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 将数据划分到一个个batch中</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># np.arange 生成从0-n的序列。/ batchsize 再向下取整变成int类型。</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># [1,2,3,4,5,6] bs = 4 =&gt; [0,0,0,0,1,1]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># bi 批的mask，只是一个mask，并没有打乱</span>
</span></span><span class="line"><span class="cl">        <span class="n">bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 记录数据集划分后的总batch数</span>
</span></span><span class="line"><span class="cl">        <span class="n">nb</span> <span class="o">=</span> <span class="n">bi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># number of batches</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>  <span class="c1"># number of images 图像总数目</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="n">bi</span>  <span class="c1"># batch index of image 记录哪些图片属于哪个batch</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">=</span> <span class="n">img_size</span>  <span class="c1"># 这里设置的是预处理后输出的图片尺寸</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">augment</span> <span class="o">=</span> <span class="n">augment</span>  <span class="c1"># 是否启用augment_hsv</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">hyp</span> <span class="o">=</span> <span class="n">hyp</span>  <span class="c1"># 超参数字典，其中包含图像增强会使用到的超参数</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">rect</span> <span class="o">=</span> <span class="n">rect</span>  <span class="c1"># 是否使用rectangular training</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 注意: 开启rect后，mosaic就默认关闭</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">mosaic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect</span>  <span class="c1"># load 4 images at a time into a mosaic (only during training)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Define labels</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 遍历设置图像对应的label路径</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># (./my_yolo_dataset/train/images/2009_004012.jpg) -&gt; (./my_yolo_dataset/train/labels/2009_004012.txt)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">label_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;images&#34;</span><span class="p">,</span> <span class="s2">&#34;labels&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&#34;.txt&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Read image shapes (wh)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 查看data文件下是否缓存有对应数据集的.shapes文件，里面存储了每张图像的width, height</span>
</span></span><span class="line"><span class="cl">        <span class="n">sp</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;.shapes&#34;</span><span class="p">)</span>  <span class="c1"># shapefile path</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span><span class="c1"># 如果有，读取文件</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># read existing shapefile</span>
</span></span><span class="line"><span class="cl">                <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 判断现有的shape文件中的行数(图像个数)是否与当前数据集中图像个数相等</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 如果不相等则认为是不同的数据集，故重新生成shape文件</span>
</span></span><span class="line"><span class="cl">                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="n">n</span><span class="p">,</span> <span class="s2">&#34;shapefile out of aync&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 如果程序第一次运行，则没有shape文件，就创建。</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># print(&#34;read {} failed [{}], rebuild {}.&#34;.format(sp, e, sp))</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># tqdm库会显示处理的进度</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 读取每张图片的size信息</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 单GPU rank = -1</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 多GPU rank = 0的是主进程</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">rank</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">              <span class="c1"># 主进程使用进度条打印信息</span>
</span></span><span class="line"><span class="cl">                <span class="n">image_files</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&#34;Reading image shapes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">image_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_files</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># </span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">exif_size</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 将所有图片的shape信息保存在.shape文件中</span>
</span></span><span class="line"><span class="cl">            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">%g</span><span class="s2">&#34;</span><span class="p">)</span>  <span class="c1"># overwrite existing (if any)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 记录每张图像的原始尺寸</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="c1"># 长方形推断 将不同大小的图片放缩到长宽都是32倍数的方法</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 将较长边设定为目标尺寸416/512…(必须是32的倍数)，短边按比例缩放，再对短边进行较少填充使短边满足32的倍数。</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Rectangular Training https://github.com/ultralytics/yolov3/issues/232</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 如果为ture，训练网络时，会使用类似原图像比例的矩形(让最长边为img_size)，而不是img_size x img_size</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#验证时才开启，减少计算量</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 注意: 开启rect后，mosaic就默认关闭</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Sort by aspect ratio</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span>  <span class="c1"># wh</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 计算每个图片的高/宽比</span>
</span></span><span class="line"><span class="cl">            <span class="n">ar</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">s</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># aspect ratio</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># argsort函数返回的是数组值从小到大的索引值</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 按照高宽比例进行排序，这样后面划分的每个batch中的图像就拥有类似的高宽比</span>
</span></span><span class="line"><span class="cl">            <span class="n">irect</span> <span class="o">=</span> <span class="n">ar</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 根据排序后的顺序重新设置图像顺序、标签顺序以及shape顺序</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">img_files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">irect</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">label_files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">irect</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">irect</span><span class="p">]</span>  <span class="c1"># wh</span>
</span></span><span class="line"><span class="cl">            <span class="n">ar</span> <span class="o">=</span> <span class="n">ar</span><span class="p">[</span><span class="n">irect</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">						<span class="c1"># 此时排序是以相似的高宽比排序的</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># set training image shapes</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 计算每个batch采用的统一尺度</span>
</span></span><span class="line"><span class="cl">            <span class="n">shapes</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="n">nb</span>  <span class="c1"># nb: number of batches</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">              <span class="c1"># 目的：每个batch里面的填充一定要一致。</span>
</span></span><span class="line"><span class="cl">                <span class="n">ari</span> <span class="o">=</span> <span class="n">ar</span><span class="p">[</span><span class="n">bi</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>  <span class="c1"># bi: batch index</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 获取第i个batch中，最小和最大高宽比</span>
</span></span><span class="line"><span class="cl">                <span class="n">mini</span><span class="p">,</span> <span class="n">maxi</span> <span class="o">=</span> <span class="n">ari</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ari</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">								
</span></span><span class="line"><span class="cl">                <span class="c1"># 如果高/宽小于1(w &gt; h)，说明此时宽大，所以将w设为img_size，h进行补偿</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">maxi</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                  	<span class="c1">#						高的比例，宽的比例</span>
</span></span><span class="line"><span class="cl">                    <span class="n">shapes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">maxi</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 如果高/宽大于1(w &lt; h)，说明此时高大，所以将h设置为img_size，w进行补偿</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">mini</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">shapes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">mini</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 计算每个batch输入网络的shape值(向上设置为32的整数倍)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 因为 小边要变成32的最近倍数，所以先除32，再向上取整再成32。</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">batch_shapes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span> <span class="o">*</span> <span class="n">img_size</span> <span class="o">/</span> <span class="mf">32.</span> <span class="o">+</span> <span class="n">pad</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># cache labels ——数据</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>  <span class="c1"># n为图像总数</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># label: [class, x, y, w, h] 其中的xywh都为相对值 ——标签</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 初始化两个参数为False</span>
</span></span><span class="line"><span class="cl">        <span class="n">extract_bounding_boxes</span><span class="p">,</span> <span class="n">labels_loaded</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 统计数据中有多少缺少标签的数据，找到了多少条数据，有多少标签是空的，有多少标签是重复的。</span>
</span></span><span class="line"><span class="cl">        <span class="n">nm</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">nd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>  <span class="c1"># number mission, found, empty, duplicate</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 这里分别命名是为了防止出现rect为False/True时混用导致计算的mAP错误</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 原因：因为开启rect时，会对数据进行重新排序，所以导致数据不匹配而mAp极低，所以对于使不使用rect都生成各自的label缓存文件。</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">rect</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">np_labels_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;.rect.npy&#34;</span>  <span class="c1"># saved labels in *.npy file</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">np_labels_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;.norect.npy&#34;</span>
</span></span><span class="line"><span class="cl">				<span class="c1"># 通过缓存载入标签</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">np_labels_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">np_labels_path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 如果载入的缓存标签个数与当前计算的图像数目相同则认为是同一数据集，直接读缓存</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">                <span class="n">labels_loaded</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 处理进度条只在第一个进程中显示</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 只在主进程中显示进度</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">rank</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pbar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_files</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 遍历载入标签文件</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pbar</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">labels_loaded</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 如果存在缓存直接从缓存读取</span>
</span></span><span class="line"><span class="cl">                <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 没有缓存，则只能从文件读取标签信息</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="c1"># 读取每一行label，并按空格划分数据</span>
</span></span><span class="line"><span class="cl">                        <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;An error occurred while loading the file </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="n">nm</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># file missing</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 如果标注信息不为空的话</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 标签信息每行必须是五个值[class, x, y, w, h]</span>
</span></span><span class="line"><span class="cl">                <span class="k">assert</span> <span class="n">l</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&#34;&gt; 5 label columns: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">file</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 必须非负</span>
</span></span><span class="line"><span class="cl">                <span class="k">assert</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&#34;negative labels: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">file</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># xywh都是相对值(&lt;=1)</span>
</span></span><span class="line"><span class="cl">                <span class="k">assert</span> <span class="p">(</span><span class="n">l</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&#34;non-normalized or out of bounds coordinate labels: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">file</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1"># 检查每一行，看是否有重复信息</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">l</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># duplicate rows</span>
</span></span><span class="line"><span class="cl">                    <span class="n">nd</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">single_cls</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">l</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># force dataset into single-class mode</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span>
</span></span><span class="line"><span class="cl">                <span class="n">nf</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># file found</span>
</span></span><span class="line"><span class="cl">								<span class="c1"># 裁剪图像中的类别实例，以供以后分类器使用</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Extract object detection boxes for a second stage classifier</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">extract_bounding_boxes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">f</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">%s%s</span><span class="s2">classifier</span><span class="si">%s%g</span><span class="s2">_</span><span class="si">%g</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>  <span class="c1"># make new output folder</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1"># 将相对坐标转为绝对坐标</span>
</span></span><span class="line"><span class="cl">                        <span class="c1"># b: x, y, w, h</span>
</span></span><span class="line"><span class="cl">                        <span class="n">b</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span>  <span class="c1"># box</span>
</span></span><span class="line"><span class="cl">                        <span class="c1"># 将宽和高设置为宽和高中的最大值</span>
</span></span><span class="line"><span class="cl">                        <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>  <span class="c1"># rectangle to square</span>
</span></span><span class="line"><span class="cl">                        <span class="c1"># 放大裁剪目标的宽高</span>
</span></span><span class="line"><span class="cl">                        <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">*</span> <span class="mf">1.3</span> <span class="o">+</span> <span class="mi">30</span>  <span class="c1"># pad</span>
</span></span><span class="line"><span class="cl">                        <span class="c1"># 将坐标格式从 x,y,w,h -&gt; xmin,ymin,xmax,ymax</span>
</span></span><span class="line"><span class="cl">                        <span class="n">b</span> <span class="o">=</span> <span class="n">xywh2xyxy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">revel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1"># 裁剪bbox坐标到图片内</span>
</span></span><span class="line"><span class="cl">                        <span class="n">b</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">[</span><span class="n">b</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                        <span class="n">b</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">[</span><span class="n">b</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                        <span class="k">assert</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">img</span><span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]]),</span> <span class="s2">&#34;Failure extracting classifier boxes&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 标注信息为空，则ne + 1</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">ne</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># file empty</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 处理进度条只在第一个进程中显示</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">rank</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 更新进度条描述信息</span>
</span></span><span class="line"><span class="cl">                <span class="n">pbar</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s2">&#34;Caching labels (</span><span class="si">%g</span><span class="s2"> found, </span><span class="si">%g</span><span class="s2"> missing, </span><span class="si">%g</span><span class="s2"> empty, </span><span class="si">%g</span><span class="s2"> duplicate, for </span><span class="si">%g</span><span class="s2"> images)&#34;</span> <span class="o">%</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">nf</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">nf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;No labels found in </span><span class="si">%s</span><span class="s2">.&#34;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 如果标签信息没有被保存成numpy的格式，且训练样本数大于1000，则将标签信息保存成numpy的格式（生成缓存）</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">labels_loaded</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Saving labels to </span><span class="si">%s</span><span class="s2"> for faster future loading&#34;</span> <span class="o">%</span> <span class="n">np_labels_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">np_labels_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>  <span class="c1"># save for next time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Cache images into memory for faster training (Warning: large datasets may exceed system RAM)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">cache_images</span><span class="p">:</span>  <span class="c1"># if training</span>
</span></span><span class="line"><span class="cl">            <span class="n">gb</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Gigabytes of cached images 用于记录缓存图像占用RAM大小</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 主进程打印，pbar存放图片索引</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">rank</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">)),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&#34;Caching images&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">pbar</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">						<span class="c1"># 两个列表</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">img_hw0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_hw</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>  <span class="c1"># max 10k images</span>
</span></span><span class="line"><span class="cl">              	<span class="c1"># 加载图片</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_hw0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_hw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>  <span class="c1"># img, hw_original, hw_resized</span>
</span></span><span class="line"><span class="cl">                <span class="n">gb</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">nbytes</span>  <span class="c1"># 用于记录缓存图像占用RAM大小</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">rank</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">pbar</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s2">&#34;Caching images (</span><span class="si">%.1f</span><span class="s2">GB)&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gb</span> <span class="o">/</span> <span class="mf">1E9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Detect corrupted images https://medium.com/joelthchao/programmatically-detect-corrupted-image-8c1b2006c3d3</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 判断图片是否破损，通过skimage读取每张图片，如果读取报错，说明图片有问题。</span>
</span></span><span class="line"><span class="cl">        <span class="n">detect_corrupted_images</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">detect_corrupted_images</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">io</span>  <span class="c1"># conda install -c conda-forge scikit-image</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&#34;Detecting corrupted images&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">_</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Corrupted image detected: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">hyp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyp</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 使用mosaic数据增强</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mosaic</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># load mosaic</span>
</span></span><span class="line"><span class="cl">            <span class="n">img</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">load_mosaic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">shapes</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># load image</span>
</span></span><span class="line"><span class="cl">            <span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">w0</span><span class="p">),</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># letterbox</span>
</span></span><span class="line"><span class="cl">            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_shapes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span>  <span class="c1"># final letterboxed shape</span>
</span></span><span class="line"><span class="cl">            <span class="n">img</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">pad</span> <span class="o">=</span> <span class="n">letterbox</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scale_up</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">augment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">shapes</span> <span class="o">=</span> <span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">w0</span><span class="p">),</span> <span class="p">((</span><span class="n">h</span> <span class="o">/</span> <span class="n">h0</span><span class="p">,</span> <span class="n">w</span> <span class="o">/</span> <span class="n">w0</span><span class="p">),</span> <span class="n">pad</span><span class="p">)</span>  <span class="c1"># for COCO mAP rescaling</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># load labels</span>
</span></span><span class="line"><span class="cl">            <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Normalized xywh to pixel xyxy format</span>
</span></span><span class="line"><span class="cl">                <span class="n">labels</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># label: class, x, y, w, h</span>
</span></span><span class="line"><span class="cl">                <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># pad width</span>
</span></span><span class="line"><span class="cl">                <span class="n">labels</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># pad height</span>
</span></span><span class="line"><span class="cl">                <span class="n">labels</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">labels</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Augment imagespace</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mosaic</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">img</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">random_affine</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                            <span class="n">degrees</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&#34;degrees&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                            <span class="n">translate</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&#34;translate&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                            <span class="n">scale</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&#34;scale&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                            <span class="n">shear</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&#34;shear&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Augment colorspace</span>
</span></span><span class="line"><span class="cl">            <span class="n">augment_hsv</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">h_gain</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&#34;hsv_h&#34;</span><span class="p">],</span> <span class="n">s_gain</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&#34;hsv_s&#34;</span><span class="p">],</span> <span class="n">v_gain</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&#34;hsv_v&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">nL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>  <span class="c1"># number of labels</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">nL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># convert xyxy to xywh</span>
</span></span><span class="line"><span class="cl">            <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyxy2xywh</span><span class="p">(</span><span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Normalize coordinates 0-1</span>
</span></span><span class="line"><span class="cl">            <span class="n">labels</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span> <span class="o">/=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># height</span>
</span></span><span class="line"><span class="cl">            <span class="n">labels</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">/=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># width</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># random left-right flip</span>
</span></span><span class="line"><span class="cl">            <span class="n">lr_flip</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 随机水平翻转</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">lr_flip</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">nL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># 1 - x_center</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># random up-down flip</span>
</span></span><span class="line"><span class="cl">            <span class="n">ud_flip</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">ud_flip</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">nL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">labels</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">labels</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># 1 - y_center</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">labels_out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nL</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  <span class="c1"># nL: number of labels</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">nL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">labels_out</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Convert BGR to RGB, and HWC to CHW(3x512x512)</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">labels_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">shapes</span><span class="p">,</span> <span class="n">index</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">coco_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;该方法是专门为cocotools统计标签信息准备，不对图像和标签作任何处理&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">o_shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">index</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># wh to hw</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># load labels</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">labels</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># label: class, x, y, w, h</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">o_shapes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      	<span class="c1"># 通过getitem拿到bs大小的数据，进行打包</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">shapes</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>  <span class="c1"># transposed</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 遍历每个label</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">          	<span class="c1"># 将bs中的每张图片的label标记不同的值，0～bs-1（因为label有六个值，第一个值用于区分每个batch中的物体信息是属于哪张图片的）</span>
</span></span><span class="line"><span class="cl">            <span class="n">l</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>  <span class="c1"># add target image index for build_targets()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># bs张img的shape完全一致，所以使用stack增加一个维度 </span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ba个label的shape因为物体数量的不同而不同，所以通过concat拼接，但是可以通过label的第一个值加以区分</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 返回图片路径，shape信息和索引。</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">path</span><span class="p">,</span> <span class="n">shapes</span><span class="p">,</span> <span class="n">index</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl"><span class="c1"># 通过索引加载图片</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># loads 1 image from dataset, returns img, original hw, resized hw</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 从缓存中读取一张图片</span>
</span></span><span class="line"><span class="cl">    <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 如果没读取到</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># not cached</span>
</span></span><span class="line"><span class="cl">      	<span class="c1"># 拿到图片文件名</span>
</span></span><span class="line"><span class="cl">        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 读取图片</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># BGR</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&#34;Image Not Found &#34;</span> <span class="o">+</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">        <span class="n">h0</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># 拿到图片原始宽高</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># img_size 设置的是预处理后输出的图片尺寸</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span>  <span class="c1"># resize image to img_size</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># if sizes are not equal</span>
</span></span><span class="line"><span class="cl">          	<span class="c1"># 判断是放大图片还是缩小图片</span>
</span></span><span class="line"><span class="cl">            <span class="n">interp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_AREA</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment</span> <span class="k">else</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span>
</span></span><span class="line"><span class="cl">            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">w0</span> <span class="o">*</span> <span class="n">r</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">h0</span> <span class="o">*</span> <span class="n">r</span><span class="p">)),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">w0</span><span class="p">),</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># img, hw_original, hw_resized</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      	<span class="c1"># 如果缓存图片则直接返回</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_hw0</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_hw</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># img, hw_original, hw_resized</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create_folder</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&#34;./new_folder&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Create floder</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># dalete output folder</span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># make new output folder</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="mosaic数据增强">mosaic数据增强：</h3>
<p>实现方法：</p>
<ul>
<li>对于生成目标大小为(s,s)的图片，先生成(2s,2s)的画布。</li>
<li>随机生成拼接图像的拼接点<code> 0.5s - 1.5s</code>之间</li>
<li>从数据集中再随便筛选出三张图片</li>
<li>遍历四张图片：
<ul>
<li>加载图片</li>
<li>如果是第一张：
<ul>
<li>先创建画布(2s,2s)</li>
<li>将图片1添加到中心点的左上区域</li>
<li>计算图片1在画布上的的两点式</li>
<li>计算图片1在原始图片上的两点式</li>
</ul>
</li>
<li>如果是第二张：<code>...</code></li>
<li>将图片<code>N</code>填充到画布上</li>
<li>计算原始图像<code>N</code>和画布之间的<code>pad</code>（因为需要修改标签，所以必须得到原始图像比画布多多少，然后修改label）</li>
<li>将<code>label</code>变成绝对坐标，并修正——&gt;乘<code>W</code>并+<code>pad</code></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">load_mosaic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    将四张图片拼接在一张马赛克图像中
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param self:
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param index: 需要获取的图像索引
</span></span></span><span class="line"><span class="cl"><span class="s2">    :return:				
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># loads images in a mosaic</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">labels4</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 拼接图像的label信息</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 随机初始化拼接图像的中心点坐标</span>
</span></span><span class="line"><span class="cl">    <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>  <span class="c1"># mosaic center x, y</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 从dataset中随机寻找三张图像进行拼接</span>
</span></span><span class="line"><span class="cl">    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>  <span class="c1"># 3 additional image indices</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 遍历四张图像进行拼接</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># load image</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># place img in img4</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># top left</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 创建马赛克图像</span>
</span></span><span class="line"><span class="cl">            <span class="n">img4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">s</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">s</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">114</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>  <span class="c1"># base image with 4 tiles</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 计算马赛克图像中的坐标信息(将图像填充到马赛克图像中)</span>
</span></span><span class="line"><span class="cl">            <span class="n">x1a</span><span class="p">,</span> <span class="n">y1a</span><span class="p">,</span> <span class="n">x2a</span><span class="p">,</span> <span class="n">y2a</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xc</span> <span class="o">-</span> <span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">yc</span> <span class="o">-</span> <span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span>  <span class="c1"># xmin, ymin, xmax, ymax (large image)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 计算截取的图像区域信息(以xc,yc为第一张图像的右下角坐标填充到马赛克图像中，丢弃越界的区域)</span>
</span></span><span class="line"><span class="cl">            <span class="n">x1b</span><span class="p">,</span> <span class="n">y1b</span><span class="p">,</span> <span class="n">x2b</span><span class="p">,</span> <span class="n">y2b</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="p">(</span><span class="n">x2a</span> <span class="o">-</span> <span class="n">x1a</span><span class="p">),</span> <span class="n">h</span> <span class="o">-</span> <span class="p">(</span><span class="n">y2a</span> <span class="o">-</span> <span class="n">y1a</span><span class="p">),</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span>  <span class="c1"># xmin, ymin, xmax, ymax (small image)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># top right</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 计算马赛克图像中的坐标信息(将图像填充到马赛克图像中)</span>
</span></span><span class="line"><span class="cl">            <span class="n">x1a</span><span class="p">,</span> <span class="n">y1a</span><span class="p">,</span> <span class="n">x2a</span><span class="p">,</span> <span class="n">y2a</span> <span class="o">=</span> <span class="n">xc</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">yc</span> <span class="o">-</span> <span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">xc</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">yc</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 计算截取的图像区域信息(以xc,yc为第二张图像的左下角坐标填充到马赛克图像中，丢弃越界的区域)</span>
</span></span><span class="line"><span class="cl">            <span class="n">x1b</span><span class="p">,</span> <span class="n">y1b</span><span class="p">,</span> <span class="n">x2b</span><span class="p">,</span> <span class="n">y2b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="p">(</span><span class="n">y2a</span> <span class="o">-</span> <span class="n">y1a</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x2a</span> <span class="o">-</span> <span class="n">x1a</span><span class="p">),</span> <span class="n">h</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># bottom left</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 计算马赛克图像中的坐标信息(将图像填充到马赛克图像中)</span>
</span></span><span class="line"><span class="cl">            <span class="n">x1a</span><span class="p">,</span> <span class="n">y1a</span><span class="p">,</span> <span class="n">x2a</span><span class="p">,</span> <span class="n">y2a</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xc</span> <span class="o">-</span> <span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">yc</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">yc</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 计算截取的图像区域信息(以xc,yc为第三张图像的右上角坐标填充到马赛克图像中，丢弃越界的区域)</span>
</span></span><span class="line"><span class="cl">            <span class="n">x1b</span><span class="p">,</span> <span class="n">y1b</span><span class="p">,</span> <span class="n">x2b</span><span class="p">,</span> <span class="n">y2b</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="p">(</span><span class="n">x2a</span> <span class="o">-</span> <span class="n">x1a</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">y2a</span> <span class="o">-</span> <span class="n">y1a</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># bottom right</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 计算马赛克图像中的坐标信息(将图像填充到马赛克图像中)</span>
</span></span><span class="line"><span class="cl">            <span class="n">x1a</span><span class="p">,</span> <span class="n">y1a</span><span class="p">,</span> <span class="n">x2a</span><span class="p">,</span> <span class="n">y2a</span> <span class="o">=</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">xc</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">yc</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 计算截取的图像区域信息(以xc,yc为第四张图像的左上角坐标填充到马赛克图像中，丢弃越界的区域)</span>
</span></span><span class="line"><span class="cl">            <span class="n">x1b</span><span class="p">,</span> <span class="n">y1b</span><span class="p">,</span> <span class="n">x2b</span><span class="p">,</span> <span class="n">y2b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x2a</span> <span class="o">-</span> <span class="n">x1a</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">y2a</span> <span class="o">-</span> <span class="n">y1a</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 将截取的图像区域填充到马赛克图像的相应位置</span>
</span></span><span class="line"><span class="cl">        <span class="n">img4</span><span class="p">[</span><span class="n">y1a</span><span class="p">:</span><span class="n">y2a</span><span class="p">,</span> <span class="n">x1a</span><span class="p">:</span><span class="n">x2a</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">y1b</span><span class="p">:</span><span class="n">y2b</span><span class="p">,</span> <span class="n">x1b</span><span class="p">:</span><span class="n">x2b</span><span class="p">]</span>  <span class="c1"># img4[ymin:ymax, xmin:xmax]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 计算pad(图像边界与马赛克边界的距离，越界的情况为负值)</span>
</span></span><span class="line"><span class="cl">        <span class="n">padw</span> <span class="o">=</span> <span class="n">x1a</span> <span class="o">-</span> <span class="n">x1b</span>
</span></span><span class="line"><span class="cl">        <span class="n">padh</span> <span class="o">=</span> <span class="n">y1a</span> <span class="o">-</span> <span class="n">y1b</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Labels 获取对应拼接图像的labels信息</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># [class_index, x_center, y_center, w, h]</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">labels</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 深拷贝，防止修改原数据</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Normalized xywh to pixel xyxy format</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 计算标注数据在马赛克图像中的坐标(绝对坐标)</span>
</span></span><span class="line"><span class="cl">            <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">padw</span>   <span class="c1"># xmin</span>
</span></span><span class="line"><span class="cl">            <span class="n">labels</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">padh</span>   <span class="c1"># ymin</span>
</span></span><span class="line"><span class="cl">            <span class="n">labels</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">padw</span>   <span class="c1"># xmax</span>
</span></span><span class="line"><span class="cl">            <span class="n">labels</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">padh</span>   <span class="c1"># ymax</span>
</span></span><span class="line"><span class="cl">        <span class="n">labels4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Concat/clip labels</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 如果这个拼接起来的画布有目标，就concat起来</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels4</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">labels4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">labels4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置上下限防止越界</span>
</span></span><span class="line"><span class="cl">        <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">labels4</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">labels4</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span>  <span class="c1"># use with random_affine</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Augment</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 随机旋转，缩放，平移以及错切</span>
</span></span><span class="line"><span class="cl">    <span class="n">img4</span><span class="p">,</span> <span class="n">labels4</span> <span class="o">=</span> <span class="n">random_affine</span><span class="p">(</span><span class="n">img4</span><span class="p">,</span> <span class="n">labels4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">degrees</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="s1">&#39;degrees&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">translate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="s1">&#39;translate&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">shear</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="s1">&#39;shear&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">border</span><span class="o">=-</span><span class="n">s</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># border to remove</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">img4</span><span class="p">,</span> <span class="n">labels4</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="图片仿射变换-数据增强">图片仿射变换 数据增强：</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">random_affine</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="p">(),</span> <span class="n">degrees</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">shear</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;随机旋转，缩放，平移以及错切&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># torchvision.transforms.RandomAffine(degrees=(-10, 10), translate=(.1, .1), scale=(.9, 1.1), shear=(-10, 10))</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># https://medium.com/uruvideo/dataset-augmentation-with-random-homographies-a8f4b44830d4</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 这里可以参考我写的博文: https://blog.csdn.net/qq_37541097/article/details/119420860</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># targets = [cls, xyxy]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 最终输出的图像尺寸，等于img4.shape / 2</span>
</span></span><span class="line"><span class="cl">    <span class="n">height</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">border</span> <span class="o">*</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="n">width</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">border</span> <span class="o">*</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Rotation and Scale</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 生成旋转以及缩放矩阵</span>
</span></span><span class="line"><span class="cl">    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># 生成对角阵</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">degrees</span><span class="p">,</span> <span class="n">degrees</span><span class="p">)</span>  <span class="c1"># 随机旋转角度</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">scale</span><span class="p">)</span>  <span class="c1"># 随机缩放因子</span>
</span></span><span class="line"><span class="cl">    <span class="n">R</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getRotationMatrix2D</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Translation</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 生成平移矩阵</span>
</span></span><span class="line"><span class="cl">    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">translate</span><span class="p">,</span> <span class="n">translate</span><span class="p">)</span> <span class="o">*</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">border</span>  <span class="c1"># x translation (pixels)</span>
</span></span><span class="line"><span class="cl">    <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">translate</span><span class="p">,</span> <span class="n">translate</span><span class="p">)</span> <span class="o">*</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">border</span>  <span class="c1"># y translation (pixels)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Shear</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 生成错切矩阵</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">shear</span><span class="p">,</span> <span class="n">shear</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>  <span class="c1"># x shear (deg)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">shear</span><span class="p">,</span> <span class="n">shear</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>  <span class="c1"># y shear (deg)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Combined rotation matrix</span>
</span></span><span class="line"><span class="cl">    <span class="n">M</span> <span class="o">=</span> <span class="n">S</span> <span class="o">@</span> <span class="n">T</span> <span class="o">@</span> <span class="n">R</span>  <span class="c1"># ORDER IS IMPORTANT HERE!!</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">border</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">M</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>  <span class="c1"># image changed</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 进行仿射变化</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpAffine</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">M</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">dsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">flags</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">,</span> <span class="n">borderValue</span><span class="o">=</span><span class="p">(</span><span class="mi">114</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">114</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Transform label coordinates</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># warp points</span>
</span></span><span class="line"><span class="cl">        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">xy</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># x1y1, x2y2, x1y2, x2y1</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># [4*n, 3] -&gt; [n, 8]</span>
</span></span><span class="line"><span class="cl">        <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">xy</span> <span class="o">@</span> <span class="n">M</span><span class="o">.</span><span class="n">T</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># create new boxes</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 对transform后的bbox进行修正(假设变换后的bbox变成了菱形，此时要修正成矩形)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">]]</span>  <span class="c1"># [n, 4]</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]]</span>  <span class="c1"># [n, 4]</span>
</span></span><span class="line"><span class="cl">        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># [n, 4]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># reject warped points outside of image</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 对坐标进行裁剪，防止越界</span>
</span></span><span class="line"><span class="cl">        <span class="n">xy</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">xy</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">w</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 计算调整后的每个box的面积</span>
</span></span><span class="line"><span class="cl">        <span class="n">area</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">h</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 计算调整前的每个box的面积</span>
</span></span><span class="line"><span class="cl">        <span class="n">area0</span> <span class="o">=</span> <span class="p">(</span><span class="n">targets</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">targets</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">targets</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="n">targets</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 计算每个box的比例</span>
</span></span><span class="line"><span class="cl">        <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">),</span> <span class="n">h</span> <span class="o">/</span> <span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">))</span>  <span class="c1"># aspect ratio</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 选取长宽大于4个像素，且调整前后面积比例大于0.2，且比例小于10的box</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">area</span> <span class="o">/</span> <span class="p">(</span><span class="n">area0</span> <span class="o">*</span> <span class="n">s</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ar</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">targets</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">targets</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="正方形推测">正方形推测</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">letterbox</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">new_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">416</span><span class="p">,</span> <span class="mi">416</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">              <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">114</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">114</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">              <span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">scale_fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">scale_up</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    将图片缩放调整到指定大小
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param img:
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param new_shape:
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param color:
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param auto:
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param scale_fill:
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param scale_up:
</span></span></span><span class="line"><span class="cl"><span class="s2">    :return:
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># [h, w]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="n">new_shape</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># scale ratio (new / old)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">new_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">scale_up</span><span class="p">:</span>  <span class="c1"># only scale down, do not scale up (for better test mAP) 对于大于指定输入大小的图片进行缩放,小于的不变</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># compute padding</span>
</span></span><span class="line"><span class="cl">    <span class="n">ratio</span> <span class="o">=</span> <span class="n">r</span><span class="p">,</span> <span class="n">r</span>  <span class="c1"># width, height ratios</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_unpad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">r</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">r</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">dw</span><span class="p">,</span> <span class="n">dh</span> <span class="o">=</span> <span class="n">new_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_unpad</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_unpad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># wh padding</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">auto</span><span class="p">:</span>  <span class="c1"># minimun rectangle 保证原图比例不变，将图像最大边缩放到指定大小</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 这里的取余操作可以保证padding后的图片是32的整数倍</span>
</span></span><span class="line"><span class="cl">        <span class="n">dw</span><span class="p">,</span> <span class="n">dh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">dw</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">dh</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>  <span class="c1"># wh padding</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">scale_fill</span><span class="p">:</span>  <span class="c1"># stretch 简单粗暴的将图片缩放到指定尺寸</span>
</span></span><span class="line"><span class="cl">        <span class="n">dw</span><span class="p">,</span> <span class="n">dh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_unpad</span> <span class="o">=</span> <span class="n">new_shape</span>
</span></span><span class="line"><span class="cl">        <span class="n">ratio</span> <span class="o">=</span> <span class="n">new_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># wh ratios</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">dw</span> <span class="o">/=</span> <span class="mi">2</span>  <span class="c1"># divide padding into 2 sides 将padding分到上下，左右两侧</span>
</span></span><span class="line"><span class="cl">    <span class="n">dh</span> <span class="o">/=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># shape:[h, w]  new_unpad:[w, h]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_unpad</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">new_unpad</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">dh</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">dh</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">))</span>  <span class="c1"># 计算上下两侧的padding</span>
</span></span><span class="line"><span class="cl">    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">dw</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">dw</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">))</span>  <span class="c1"># 计算左右两侧的padding</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">copyMakeBorder</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>  <span class="c1"># add border</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="p">(</span><span class="n">dw</span><span class="p">,</span> <span class="n">dh</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="hsv数据增强">hsv数据增强</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">augment_hsv</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">h_gain</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s_gain</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">v_gain</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 这里可以参考我写的博文:https://blog.csdn.net/qq_37541097/article/details/119478023</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="n">h_gain</span><span class="p">,</span> <span class="n">s_gain</span><span class="p">,</span> <span class="n">v_gain</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># random gains</span>
</span></span><span class="line"><span class="cl">    <span class="n">hue</span><span class="p">,</span> <span class="n">sat</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">dtype</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">dtype</span>  <span class="c1"># uint8</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">lut_hue</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="mi">180</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">lut_sat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">lut_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">img_hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">merge</span><span class="p">((</span><span class="n">cv2</span><span class="o">.</span><span class="n">LUT</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">lut_hue</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LUT</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">lut_sat</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LUT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">lut_val</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img_hsv</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_HSV2BGR</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">img</span><span class="p">)</span>  <span class="c1"># no return needed</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="损失计算">损失计算</h2>
<blockquote>
<p>目标检测的目标值都是动态生成，所以计算损失前先生成目标值。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>  <span class="c1"># predictions, targets, model</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">#p：[bs, num_of_anchor(3), grid_y, grid_x, obj + xywh + classes]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#target：[number of label,6]</span>
</span></span><span class="line"><span class="cl">    <span class="n">device</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">device</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 分类损失</span>
</span></span><span class="line"><span class="cl">    <span class="n">lcls</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># Tensor(0)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 定位损失</span>
</span></span><span class="line"><span class="cl">    <span class="n">lbox</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># Tensor(0)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 置信度损失</span>
</span></span><span class="line"><span class="cl">    <span class="n">lobj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># Tensor(0)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 传入 预测信息，正样本信息，模型</span>
</span></span><span class="line"><span class="cl">    <span class="n">tcls</span><span class="p">,</span> <span class="n">tbox</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">anchors</span> <span class="o">=</span> <span class="n">build_targets</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>  <span class="c1"># targets</span>
</span></span><span class="line"><span class="cl">    <span class="n">h</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyp</span>  <span class="c1"># hyperparameters</span>
</span></span><span class="line"><span class="cl">    <span class="n">red</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>  <span class="c1"># Loss reduction (sum or mean)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Define criteria</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 定义损失函数</span>
</span></span><span class="line"><span class="cl">    <span class="n">BCEcls</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">(</span><span class="n">pos_weight</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;cls_pw&#39;</span><span class="p">]],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">reduction</span><span class="o">=</span><span class="n">red</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">BCEobj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">(</span><span class="n">pos_weight</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;obj_pw&#39;</span><span class="p">]],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">reduction</span><span class="o">=</span><span class="n">red</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># class label smoothing https://arxiv.org/pdf/1902.04103.pdf eqn 3</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 原始正样本为1，负样本为0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 将正负样本smooth成cp，cn</span>
</span></span><span class="line"><span class="cl">    <span class="n">cp</span><span class="p">,</span> <span class="n">cn</span> <span class="o">=</span> <span class="n">smooth_BCE</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># focal loss 如果指定focal，初始化focalloss损失函数</span>
</span></span><span class="line"><span class="cl">    <span class="n">g</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;fl_gamma&#39;</span><span class="p">]</span>  <span class="c1"># focal loss gamma</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">g</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">BCEcls</span><span class="p">,</span> <span class="n">BCEobj</span> <span class="o">=</span> <span class="n">FocalLoss</span><span class="p">(</span><span class="n">BCEcls</span><span class="p">,</span> <span class="n">g</span><span class="p">),</span> <span class="n">FocalLoss</span><span class="p">(</span><span class="n">BCEobj</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># per output</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>  <span class="c1"># layer index, layer predictions</span>
</span></span><span class="line"><span class="cl">        <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gj</span><span class="p">,</span> <span class="n">gi</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># image_idx, anchor_idx, grid_y, grid_x</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># tobj = [batch,num_of_anchor,grid_y,grid_x,obj]</span>
</span></span><span class="line"><span class="cl">        <span class="n">tobj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pi</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># target obj</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">nb</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 一个batch中number of positive samples</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">nb</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 对应匹配到正样本的预测信息（预测的是宽高）pi是一个六维张量，索引四维，取得obj + xywh + classes</span>
</span></span><span class="line"><span class="cl">            <span class="n">ps</span> <span class="o">=</span> <span class="n">pi</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gj</span><span class="p">,</span> <span class="n">gi</span><span class="p">]</span>  <span class="c1"># prediction subset corresponding to targets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># GIoU 通过公式反解出预测边界框，使用GIOU计算定位损失</span>
</span></span><span class="line"><span class="cl">            <span class="n">pxy</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">pwh</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mf">1E3</span><span class="p">)</span> <span class="o">*</span> <span class="n">anchors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">pbox</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">pxy</span><span class="p">,</span> <span class="n">pwh</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># predicted box</span>
</span></span><span class="line"><span class="cl">            <span class="n">giou</span> <span class="o">=</span> <span class="n">bbox_iou</span><span class="p">(</span><span class="n">pbox</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span> <span class="n">tbox</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x1y1x2y2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">GIoU</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># giou(prediction, target)</span>
</span></span><span class="line"><span class="cl">            <span class="n">lbox</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">giou</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># giou loss</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Obj 使用GIOU计算置信度目标值</span>
</span></span><span class="line"><span class="cl">            <span class="n">tobj</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gj</span><span class="p">,</span> <span class="n">gi</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">gr</span><span class="p">)</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">gr</span> <span class="o">*</span> <span class="n">giou</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">tobj</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>  <span class="c1"># giou ratio</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Class 当检测目标数大于1时才会计算类别损失</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">nc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># cls loss (only if multiple classes)</span>
</span></span><span class="line"><span class="cl">                <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">ps</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:],</span> <span class="n">cn</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># targets</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 类别填充cp</span>
</span></span><span class="line"><span class="cl">                <span class="n">t</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">nb</span><span class="p">),</span> <span class="n">tcls</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cp</span>
</span></span><span class="line"><span class="cl">                <span class="n">lcls</span> <span class="o">+=</span> <span class="n">BCEcls</span><span class="p">(</span><span class="n">ps</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:],</span> <span class="n">t</span><span class="p">)</span>  <span class="c1"># BCE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Append targets to text file</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># with open(&#39;targets.txt&#39;, &#39;a&#39;) as file:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#     [file.write(&#39;%11.5g &#39; * 4 % tuple(x) + &#39;\n&#39;) for x in torch.cat((txy[i], twh[i]), 1)]</span>
</span></span><span class="line"><span class="cl">				<span class="c1"># BCE计算置信度损失</span>
</span></span><span class="line"><span class="cl">        <span class="n">lobj</span> <span class="o">+=</span> <span class="n">BCEobj</span><span class="p">(</span><span class="n">pi</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">tobj</span><span class="p">)</span>  <span class="c1"># obj loss</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 乘上每种损失的对应权重</span>
</span></span><span class="line"><span class="cl">    <span class="n">lbox</span> <span class="o">*=</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;giou&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">lobj</span> <span class="o">*=</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">lcls</span> <span class="o">*=</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;cls&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># loss = lbox + lobj + lcls</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;box_loss&#34;</span><span class="p">:</span> <span class="n">lbox</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;obj_loss&#34;</span><span class="p">:</span> <span class="n">lobj</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;class_loss&#34;</span><span class="p">:</span> <span class="n">lcls</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">build_targets</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Build targets for compute_loss(), input targets(image_idx,class,x,y,w,h)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 目标数</span>
</span></span><span class="line"><span class="cl">    <span class="n">nt</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># </span>
</span></span><span class="line"><span class="cl">    <span class="n">tcls</span><span class="p">,</span> <span class="n">tbox</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">anch</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 获得对于(image_idx,class,x,y,w,h)的增益，默认为1</span>
</span></span><span class="line"><span class="cl">    <span class="n">gain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">targets</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>  <span class="c1"># normalized to gridspace gain</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># 是否采用GPU训练</span>
</span></span><span class="line"><span class="cl">    <span class="n">multi_gpu</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">DistributedDataParallel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 循环yololayer，拿到yololayer所在模型中的层数</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">yolo_layers</span><span class="p">):</span>  <span class="c1"># j: [89, 101, 113]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取该yolo predictor对应的anchors</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 注意anchor_vec是anchors缩放到对应特征层上的尺度</span>
</span></span><span class="line"><span class="cl">        <span class="n">anchors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">module_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">anchor_vec</span> <span class="k">if</span> <span class="n">multi_gpu</span> <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">module_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">anchor_vec</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># p[i].shape: [batch_size, 3, grid_h, grid_w, num_params]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># gain = [1,1,grid_w,grid_h,grid_w,grid_h]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 目的：将相对坐标转化到这个特征层上的绝对坐标</span>
</span></span><span class="line"><span class="cl">        <span class="n">gain</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>  <span class="c1"># xyxy gain</span>
</span></span><span class="line"><span class="cl">        <span class="n">na</span> <span class="o">=</span> <span class="n">anchors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># number of anchors</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># [3] -&gt; [3, 1] -&gt; [3, nt]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 将anchor range一下，view一下变成列，有多少物体，再复制多少列。(na,nt)</span>
</span></span><span class="line"><span class="cl">        <span class="n">at</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">na</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nt</span><span class="p">)</span>  <span class="c1"># anchor tensor, same as .repeat_interleave(nt)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Match targets to anchors</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">offsets</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">targets</span> <span class="o">*</span> <span class="n">gain</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">nt</span><span class="p">:</span>  <span class="c1"># 如果存在target的话</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 通过计算anchor模板与所有target的wh_iou来匹配正样本</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># j: [na, nt] , iou_t = 0.20</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 左上角重合，计算iou。并找出大于指定阈值的</span>
</span></span><span class="line"><span class="cl">            <span class="n">j</span> <span class="o">=</span> <span class="n">wh_iou</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="s1">&#39;iou_t&#39;</span><span class="p">]</span>  <span class="c1"># iou(3,n) = wh_iou(anchors(3,2), gwh(n,2))</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># t.repeat(na, 1, 1): [nt, 6] -&gt; [3, nt, 6]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 获取正样本对应的anchor模板与target信息</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 具体一个物体与一个anchor的iou大于阈值还是与多个anchor的iou大于阈值都没有关系。不管一个物体对应几个anchor，a与t对应——有一个anchor就有一个target</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">at</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># filter</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Define</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># long等于to(torch.int64), 数值向下取整</span>
</span></span><span class="line"><span class="cl">        <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># image_idx, class</span>
</span></span><span class="line"><span class="cl">        <span class="n">gxy</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># grid xy</span>
</span></span><span class="line"><span class="cl">        <span class="n">gwh</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>  <span class="c1"># grid wh</span>
</span></span><span class="line"><span class="cl">        <span class="n">gij</span> <span class="o">=</span> <span class="p">(</span><span class="n">gxy</span> <span class="o">-</span> <span class="n">offsets</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>  <span class="c1"># 匹配targets所在的grid cell左上角坐标</span>
</span></span><span class="line"><span class="cl">        <span class="n">gi</span><span class="p">,</span> <span class="n">gj</span> <span class="o">=</span> <span class="n">gij</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># grid xy indices</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Append</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># gain[3]: grid_h, gain[2]: grid_w</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># image_idx, anchor_idx, 正样本中心点的y坐标，正样本中心点的x坐标</span>
</span></span><span class="line"><span class="cl">        <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gj</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gain</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">gi</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gain</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#计算物体中心点与gridcell左上角点的偏移量和物体gt box的wh拼接起来</span>
</span></span><span class="line"><span class="cl">        <span class="n">tbox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">gxy</span> <span class="o">-</span> <span class="n">gij</span><span class="p">,</span> <span class="n">gwh</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">        <span class="n">anch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>  <span class="c1"># 正样本对应的anchors</span>
</span></span><span class="line"><span class="cl">        <span class="n">tcls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>  <span class="c1"># 正样本对应的class</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># if any targets</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 目标的标签数值不能大于给定的目标类别数</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">nc</span><span class="p">,</span> <span class="s1">&#39;Model accepts </span><span class="si">%g</span><span class="s1"> classes labeled from 0-</span><span class="si">%g</span><span class="s1">, however you labelled a class </span><span class="si">%g</span><span class="s1">. &#39;</span> \
</span></span><span class="line"><span class="cl">                                       <span class="s1">&#39;See https://github.com/ultralytics/yolov3/wiki/Train-Custom-Data&#39;</span> <span class="o">%</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                                           <span class="n">model</span><span class="o">.</span><span class="n">nc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">nc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># tcls：类别信息</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># tbox：定位信息</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># indices：索引信息</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># anch ： anchor信息</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tcls</span><span class="p">,</span> <span class="n">tbox</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">anch</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">wh_iou</span><span class="p">(</span><span class="n">wh1</span><span class="p">,</span> <span class="n">wh2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Returns the nxm IoU matrix. wh1 is nx2, wh2 is mx2</span>
</span></span><span class="line"><span class="cl">    <span class="n">wh1</span> <span class="o">=</span> <span class="n">wh1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># [N,1,2]</span>
</span></span><span class="line"><span class="cl">    <span class="n">wh2</span> <span class="o">=</span> <span class="n">wh2</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>  <span class="c1"># [1,M,2]</span>
</span></span><span class="line"><span class="cl">    <span class="n">inter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">wh1</span><span class="p">,</span> <span class="n">wh2</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># [N,M]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">inter</span> <span class="o">/</span> <span class="p">(</span><span class="n">wh1</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">wh2</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">inter</span><span class="p">)</span>  <span class="c1"># iou = inter / (area1 + area2 - inter)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="总结">总结：</h2>
<p>目标检测与图像分类等任务有着很大的不同。从数据，模型和评价函数三方面分析两种方向的不同：</p>
<ul>
<li><strong>数据</strong>：
<ul>
<li>图像分类
<ul>
<li>只有三种数据：图片<code>x</code>，模型输出<code>pred</code>，真实标签<code>label</code>；</li>
<li>标准数据集中的图像大小相同，输出类别形状固定，可以直接批处理；</li>
<li>输入输出固定；</li>
<li>图像类别（<code>label</code>）不会变化。</li>
<li>图像增强只用对图像做操作。</li>
</ul>
</li>
<li>目标检测
<ul>
<li>有四种数据：图像<code>x</code>，模型输出物体所在位置和类别<code>pred</code>，物体真实标签<code>label</code>，运算时的目标值<code>targets</code>；</li>
<li>标准数据集中的图像大小不一，通常需要使用<code>Square training</code>和<code>Rectangular inference</code>统一尺寸；</li>
<li>每张图片上的物体数量截然不同，批之间乃至图片之间的<code>targets</code>不同，不能常规处理，需要借助<code>collate_fn</code>。</li>
<li>根据网络的训练，目标值（<code>targets</code>）不断变化，所以每次计算损失函数之前必须先计算目标值。</li>
<li>图像增强既要对图像做操作，也要对标签做操作。</li>
</ul>
</li>
</ul>
</li>
<li><strong>模型</strong>：两种方向的模型都可以随意更换，但是目标检测需要有检测头。</li>
<li><strong>评价函数</strong>：
<ul>
<li>图像分类：多用交叉熵；</li>
<li>目标检测：定位损失用<code>类IOU</code>损失；置信度损失和分类损失用<code>BCE</code></li>
</ul>
</li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">杨浩伟</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2023-02-08
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/yolov3/">YOLOv3</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/detector/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Detector</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/hugo_4/">
            <span class="next-text nav-default">Hugo支持数学公式</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
      <a href="http://localhost:1313" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="http://localhost:1313" class="iconfont icon-twitter" title="twitter"></a>
      <a href="http://localhost:1313" class="iconfont icon-facebook" title="facebook"></a>
      <a href="http://localhost:1313" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="http://localhost:1313" class="iconfont icon-google" title="google"></a>
      <a href="http://localhost:1313" class="iconfont icon-github" title="github"></a>
      <a href="http://localhost:1313" class="iconfont icon-weibo" title="weibo"></a>
      <a href="http://localhost:1313" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="http://localhost:1313" class="iconfont icon-douban" title="douban"></a>
      <a href="http://localhost:1313" class="iconfont icon-pocket" title="pocket"></a>
      <a href="http://localhost:1313" class="iconfont icon-tumblr" title="tumblr"></a>
      <a href="http://localhost:1313" class="iconfont icon-instagram" title="instagram"></a>
      <a href="http://localhost:1313" class="iconfont icon-gitlab" title="gitlab"></a>
      <a href="http://localhost:1313" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="http://localhost:1313/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2017 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>杨浩伟</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
